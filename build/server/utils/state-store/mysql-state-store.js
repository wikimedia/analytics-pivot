"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var mysql=require("mysql");var Q=require("q");var state_store_1=require("./state-store");var MysqlStateStore=function(e){tslib_1.__extends(t,e);function t(t,n){var r=e.call(this,t,n)||this;r.table=n.getTable();r.latestKnownVersion=0;r.resetConnection();r.setUpConnection();setInterval(function(){r.setUpConnection()},3e4).unref();return r}t.prototype.setUpConnection=function(){var e=this;if(this.connected)return;var n=mysql.createConnection(this.settingsLocation.getUri());n.on("error",function(t){if(t.code==="PROTOCOL_CONNECTION_LOST"){e.logger.error("MySQL connection lost");e.resetConnection();return}throw t});n.connect(function(r){if(r){e.logger.error("Could not connect to MySQL store because "+r.code);e.connection.reject(r);e.resetConnection();return}n.query(t.SCHEMA,[e.table],function(t,r,o){if(t){e.logger.error("Could not init schema [table: "+e.table+"] because "+t.code);e.connection.reject(t);e.resetConnection();return}e.logger.log("Connected to MySQL state store [table: "+e.table+"]");e.onConnected(n);e.setUpPollingIfNeeded()})})};t.prototype.onConnected=function(e){this.connected=true;this.connection.resolve(e)};t.prototype.resetConnection=function(){if(this.pollingTimer){clearInterval(this.pollingTimer);this.pollingTimer=null}this.connection=Q.defer();this.connected=false};t.prototype.resetIfFatal=function(e){if(!e.fatal)return;this.resetConnection()};t.prototype.setUpPollingIfNeeded=function(){var e=this;var t=this.settingsLocation.getPollingInterval();if(t&&this.connected){this.logger.log("Setting up polling for MySQL setting store [pollingInterval: "+t+"ms]");this.pollingTimer=setInterval(function(){e.readLatestVersion().then(function(t){if(e.latestKnownVersion<t){e.logger.log("Found newer settings version: "+t+" (had "+e.latestKnownVersion+")");e.readState().then(function(t){e.emit("update",t)})}})},t).unref()}};t.prototype.readLatestVersion=function(){var e=this;return this.connection.promise.then(function(t){var n=Q.defer();t.query("SELECT version FROM ?? ORDER BY version DESC LIMIT 1;",[e.table],function(t,r,o){if(t){e.resetIfFatal(t);n.reject(t);return}if(r.length>1){n.reject(new Error("bad number of rows"));return}if(r.length===0){n.resolve(0);return}n.resolve(Number(r[0].version))});return n.promise})};t.prototype.readState=function(){var e=this;return this.connection.promise.then(function(t){var n=Q.defer();t.query("SELECT version, state FROM ?? ORDER BY version DESC LIMIT 1;",[e.table],function(t,r,o){if(t){e.resetIfFatal(t);n.reject(t);return}if(r.length>1){n.reject(new Error("bad number of rows"));return}if(r.length===0){var i=e.settingsLocation.getInitialSettings()||"";if(typeof i!=="string")i=JSON.stringify(i);n.resolve(i);return}e.latestKnownVersion=Number(r[0].version);n.resolve(String(r[0].state))});return n.promise})};t.prototype.writeState=function(e,t){var n=this;return this.connection.promise.then(function(r){var o=Q.defer();r.query("INSERT INTO ?? (version, state) VALUES (?, ?);",[n.table,e,t],function(t,r,i){if(t){n.resetIfFatal(t);o.reject(t);return}n.logger.log("Wrote MySQL state v"+e);n.latestKnownVersion=e;o.resolve(null)});return o.promise})};return t}(state_store_1.StateStore);MysqlStateStore.SCHEMA="CREATE TABLE IF NOT EXISTS ?? (\n  version INT NOT NULL PRIMARY KEY,\n  created_on TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  state BLOB NOT NULL\n  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;";exports.MysqlStateStore=MysqlStateStore;