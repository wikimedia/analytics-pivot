"use strict";Object.defineProperty(exports,"__esModule",{value:true});var nike_hercules_1=require("@implydata/nike-hercules");var crypto=require("crypto");var hasOwnProperty=require("has-own-prop");var Q=require("q");function getDefaultCookie(){var e=2592e6;var t=new Date;t.setMonth(t.getMonth()+1);return{maxAge:e,expires:t}}var USED={token:"#used#",cookie:getDefaultCookie()};var TokenManager=function(){function e(e,t){this.inviteStore=nike_hercules_1.storeFactory(e);this.logger=t.logger}e.generateToken=function(){return{token:crypto.randomBytes(15).toString("hex"),cookie:getDefaultCookie()}};e.prototype.setUsed=function(e){this.setToken(e,USED)};e.prototype.isUsed=function(e){return this.getTokenValue(e).then(function(e){return e===USED.token})};e.prototype.setToken=function(e,t){var r=this.logger;var n=Q.defer();r.log("Setting token for '"+e+"'");this.inviteStore.set(e,t,function(e,t){if(e){n.reject(e)}else{n.resolve(null)}});return n.promise};e.prototype.getToken=function(e){var t=this.logger;var r=Q.defer();t.log("Getting token for '"+e+"'");this.inviteStore.get(e,function(e,t){if(e){r.reject({message:e.message})}else if(!t||!hasOwnProperty(t,"token")){r.resolve(null)}else{r.resolve(t)}});return r.promise};e.prototype.getTokenValue=function(e){return this.getToken(e).then(function(e){if(!e)return Q.reject(new Error("invalid token"));return e.token})};e.prototype.getOrCreateToken=function(t){var r=this;return this.getToken(t).then(function(n){if(!n){var o=e.generateToken();return r.setToken(t,o).then(function(){return o})}else{return Q(n)}})};e.prototype.processToken=function(e,t){var r=this;var n=this.logger;n.log("Processing token for '"+e+"'");return this.getTokenValue(e).then(function(e){if(e!==t){throw new Error("invalid token")}}).then(function(){return r.setUsed(e)})};return e}();exports.TokenManager=TokenManager;