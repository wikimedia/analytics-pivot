"use strict";Object.defineProperty(exports,"__esModule",{value:true});var crypto=require("crypto");var fs=require("fs-promise");var path=require("path");var Q=require("q");var PUB="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtUf5vzKS8x4Fi60m8ejD\nIkzGES3B1YEjqglIbpsa8k1CDsDcoEKzQFP+H5vAcMuWkDDvq+Cw0UiXTHg/RbVo\nvHtRUzm4ap7x0IO/b4ia+JxRIYokqxKKPpF/JPkHb2qkLh7gfnNmGoRyLe0zCpnZ\nvIMv51GZ9HV3HzIvcC7SBcBF4QB1BCSooW27Xbs5uKxCeKsNZH0fmTH4FShWkvX/\nHsE065tk0ptPVs2A0XED0iyFiTlrakRAp7uOHHGZI07nDDAc8TAj7aM0v3lFUh21\nF8l5c/yrEa58wuI7bXt3sunA+Apji/HTm/Vd2sfUl6sU8224UdNkU04xBaoxWf4J\nfQIDAQAB\n-----END PUBLIC KEY-----";var LicenseManager=function(){function e(r){var t=this;this.hasLicense=false;this.showWelcome=false;this.expired=false;this.checker=null;this.logger=r.logger;this.varDir=r.varDir;this.licenseFile=r.licenseFile;this.hasValidLicense().then(function(r){if(r){t.hasLicense=true}else{t.checker=setInterval(t.doCheck.bind(t),e.CHECK_INTERVAL);if(t.checker&&t.checker.unref)t.checker.unref();t.getOrSetFirstRunFile().then(function(r){if(r.created){t.showWelcome=true}if(e.expiredDate(r.firstRun)){t.logger.log("Pivot evaluation license expired");t.expired=true}})}}).done()}e.validate=function(e){if(typeof e!=="string")return null;var r=e.trim().split("|");if(r.length!==3)return null;var t=r[0],i=r[1],n=r[2];var a=new Date(i+"T00:00:00.000Z");if(isNaN(a))return null;var s=crypto.createVerify("RSA-SHA256");s.update(t+"|"+i);return s.verify(PUB,n,"base64")?t:null};e.expiredDate=function(r){return Date.now()-r.valueOf()>e.EVAL_INTERVAL};e.prototype.isExpired=function(){return this.expired};e.prototype.isWelcomeNeeded=function(){return this.showWelcome};e.prototype.welcomeShown=function(){this.showWelcome=false};e.prototype.hasValidLicense=function(){var r=this;var t=this.licenseFile;return Q(fs.readFile(t,{encoding:"utf-8"})).then(function(i){var n=e.validate(i);if(n){r.logger.log("License accepted. [user: "+n+", file: "+t+"]")}else{r.logger.log("License rejected.")}return Boolean(n)},function(){return false})};e.prototype.getOrSetFirstRunFile=function(){var e=path.join(this.varDir,".pivot-first-run");return Q(fs.readFile(e,{encoding:"utf-8"})).then(function(e){var r=new Date(e.trim());if(isNaN(r))throw new Error("invalid date");return{created:false,firstRun:r}}).catch(function(r){var t=new Date;return Q(fs.writeFile(e,t.toISOString())).then(function(){return{created:true,firstRun:t}})})};e.prototype.doCheck=function(){var r=this;this.hasValidLicense().then(function(t){if(t){r.hasLicense=true;clearInterval(r.checker)}else{r.getOrSetFirstRunFile().then(function(t){if(e.expiredDate(t.firstRun)){r.logger.log("Pivot evaluation license expired.");r.expired=true;clearInterval(r.checker)}})}})};return e}();LicenseManager.CHECK_INTERVAL=6e4;LicenseManager.EVAL_INTERVAL=2592e6;exports.LicenseManager=LicenseManager;