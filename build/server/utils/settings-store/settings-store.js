"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var events_1=require("events");var fs=require("fs-promise");var yaml=require("js-yaml");var Q=require("q");var models_1=require("../../../common/models");var yaml_helper_1=require("../yaml-helper/yaml-helper");function readSettingsFactory(e,t){return function(){return Q(fs.readFile(e,"utf-8").catch(function(e){if(e.code!=="ENOENT")throw e;return""}).then(function(e){switch(t){case"json-pretty":case"json":return JSON.parse(e||"{}");case"yaml":return yaml.safeLoad(e);default:throw new Error("unsupported format '"+t+"'")}}).then(function(e){return models_1.AppSettings.fromJS(e,{visualizations:models_1.MANIFESTS})}))}}function writeSettingsFactory(e,t){return function(r){return Q.fcall(function(){switch(t){case"json-pretty":return JSON.stringify(r,null,2);case"json":return JSON.stringify(r);case"yaml":return yaml_helper_1.appSettingsToYAML(r,false);default:throw new Error("unsupported format '"+t+"'")}}).then(function(t){return fs.writeFile(e,t)})}}var SettingsStore=function(e){tslib_1.__extends(t,e);function t(t){if(t===void 0){t=false}var r=e.call(this)||this;r.needsAutoLoader=t;return r}t.fromTransient=function(e,r){if(r===void 0){r=true}var n=new t(true);n.readSettings=function(){if(n.autoLoader){return n.autoLoader(e)}else{return Q(e)}};if(r){n.hasUpdateOnLoad=function(){return Q(true)}}return n};t.fromReadOnlyFile=function(e,r){var n=new t;n.readSettings=readSettingsFactory(e,r);return n};t.fromWritableFile=function(e,r){var n=new t;n.readSettings=readSettingsFactory(e,r);n.writeSettings=writeSettingsFactory(e,r);return n};t.fromStateStore=function(e){var r=new t;function n(e){return models_1.AppSettings.fromJS(JSON.parse(e||"{}"),{visualizations:models_1.MANIFESTS})}r.readSettings=function(){return Q(e.readState().then(n))};r.writeSettings=function(t){return Q.fcall(function(){return JSON.stringify(t)}).then(function(r){return e.writeState(t.getVersion(),r)})};e.on("update",function(e){r.emit("update",n(e))});return r};return t}(events_1.EventEmitter);exports.SettingsStore=SettingsStore;