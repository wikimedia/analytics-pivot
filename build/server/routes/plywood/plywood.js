"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var chronoshift_1=require("chronoshift");var plywood_1=require("plywood");var config_1=require("../../config");var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/",function(e,r){var t=e.body,s=t.dataCube,o=t.dataSource,a=t.expression,n=t.timezone,u=t.settingsVersion;s=s||o;if(config_1.LICENSE_MANAGER.isExpired()){r.status(501).send({error:"evaluation expired"});return}if(typeof s!=="string"){r.status(400).send({error:"must have a dataCube"});return}var i=null;if(typeof n==="string"){try{i=chronoshift_1.Timezone.fromJS(n)}catch(e){r.status(400).send({error:"bad timezone",message:e.message});return}}var c=null;try{c=plywood_1.Expression.fromJS(a)}catch(e){r.status(400).send({error:"bad expression",message:e.message});return}e.getFullSettings({expectedVersion:u,dataCubeOfInterest:s}).then(function(e){var t=e.appSettings,o=e.executors;var a=false;if(u<t.getVersion()){a=true}var n=t.getDataCube(s);if(!n){r.status(400).send({error:"unknown data cube"});return null}var l=o[n.name];if(!l){r.status(400).send({error:"unqueryable data cube"});return null}return l(c,{timezone:i}).then(function(e){var t={result:plywood_1.Dataset.isDataset(e)?e.toJS():e};if(a)t.action="update";r.json(t)},function(e){console.log("error:",e.message);if(e.hasOwnProperty("stack")){console.log(e.stack)}r.status(500).send({error:"could not compute",message:e.message})})})});module.exports=router;