"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var models_1=require("../../../common/models");var strings_1=require("../../../common/utils/constants/strings");var config_1=require("../../config");var views_1=require("../../views");var router=nike_hercules_1.HerculesServer.makeRouter();router.get("/",function(e,t,s){var r=e.query.user;var n=e.query.token;config_1.TOKEN_MANAGER.getTokenValue(r).then(function(s){if(s===n){e.getFullSettings().then(function(e){var n=e.appSettings;t.send(views_1.inviteLayout({version:config_1.VERSION,title:strings_1.STRINGS.loginToPivot,user:r,inviteToken:s,customization:n.customization}))})}config_1.TOKEN_MANAGER.isUsed(r).then(function(e){if(e){t.send("This link has expired.")}else{t.redirect("/")}})}).catch(function(e){console.log("error:",JSON.stringify(e));if(e.hasOwnProperty("stack")){console.log(e.stack)}t.status(500).send({error:"Could not process link",message:e.message})}).done()});router.post("/accept",function(e,t,s){var r=e.body,n=r.name,o=r.pass,i=r.token;if(typeof n!=="string"){t.status(400).send({error:"must have a name"});return}if(typeof o!=="string"){t.status(400).send({error:"must have a pass"});return}if(typeof i!=="string"){t.status(400).send({error:"must have a token"});return}var u;var a;e.getFullSettings().then(function(e){var t=e.appSettings;u=t.getUser(n);if(!u)throw new Error("no such user");a=new models_1.UserAuth({name:n,pass:o});var s=t.customization.getIssueWithPass(o);if(s)throw new Error(s);return config_1.TOKEN_MANAGER.processToken(n,i).then(function(){u=u.changeStatus(models_1.User.STATUS_OK);return t.updateAuthPass(a,o,config_1.SERVER_SETTINGS.getDefaultAdminPass())})}).then(function(e){return e.addOrUpdateUser(u.changeStatus(models_1.User.STATUS_OK))}).then(function(e){return config_1.SETTINGS_MANAGER.updateSettings(e.incrementVersion())}).then(function(){e.session["loggedIn"]=true;e.session["user"]=u;t.send({status:"ok"})},function(e){console.log("error:",e.message);if(e.hasOwnProperty("stack")){console.log(e.stack)}t.status(500).send({error:"could not update",message:e.message})}).done()});module.exports=router;