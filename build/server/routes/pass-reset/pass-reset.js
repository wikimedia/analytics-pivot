"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var config_1=require("../../config");function sendUpdateError(e,t){console.log("error:",t.message);if(t.hasOwnProperty("stack")){console.log(t.stack)}e.status(500).send({error:"could not update",message:t.message})}var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/",function(e,t,r){var n=e.body,s=n.name,o=n.pass;if(typeof s!=="string"){t.status(400).send({error:"must have a name"});return}if(typeof o!=="string"){t.status(400).send({error:"must have a pass"});return}e.getFullSettings().then(function(e){var t=e.appSettings;var r=t.getUserAuth(s,config_1.SERVER_SETTINGS.getDefaultAdminPass());if(!r)throw new Error("no such user");return t.updateAuthPass(r,o,config_1.SERVER_SETTINGS.getDefaultAdminPass())}).then(function(e){return config_1.SETTINGS_MANAGER.updateSettings(e.incrementVersion())}).then(function(){t.send({status:"ok"})},function(e){sendUpdateError(t,e)}).done()});router.post("/mklink",function(e,t,r){var n=e.body.name;if(typeof n!=="string"){t.status(400).send({error:"must have a name"});return}config_1.TOKEN_MANAGER.getOrCreateToken(n).then(function(r){var s=e.protocol+"://"+e.get("Host")+"/invite-user?user="+n+"&token="+r.token;t.send({link:s})}).catch(function(e){sendUpdateError(t,e)}).done()});module.exports=router;