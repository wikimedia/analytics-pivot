"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var plywood_1=require("plywood");var config_1=require("../../config");var router=nike_hercules_1.HerculesServer.makeRouter();var outputFunctions={json:function(e){return JSON.stringify(e,null,2)},csv:function(e){return e.toCSV({columnOrdering:"keys-first"})},tsv:function(e){return e.toTSV({columnOrdering:"keys-first"})}};router.post("/",function(e,r){var t=e.body,n=t.outputType,u=t.query;if(config_1.LICENSE_MANAGER.isExpired()){r.status(501).send({error:"evaluation expired"});return}if(typeof u!=="string"){var s="Query must be a string";r.status(400).send(s);return}var o;try{o=plywood_1.Expression.parseSQL(u)}catch(e){var s="Could not parse query as SQL: "+e.message;r.status(400).send(s);return}if(typeof n!=="string"){n="json"}var a;a=outputFunctions[n];if(a===undefined){var s="Invalid output type: "+n;r.status(400).send(s);return}var i=o.expression;var d=o.table;if(!d){var s="Could not determine data cube name";r.status(400).send(s);return}i=i.substitute(function(e){if(e instanceof plywood_1.RefExpression&&e.name===d){return plywood_1.$("main")}return null});e.getFullSettings({dataCubeOfInterest:d}).then(function(e){var t=e.appSettings,u=e.executors;var s=t.getDataCube(d);if(!s){r.status(400).send({error:"unknown data cube"});return null}var o=u[s.name];if(!o){r.status(400).send({error:"unqueryable data cube"});return null}return o(i).then(function(e){r.type(n);r.send(a(plywood_1.Dataset.fromJS(e.toJS())))},function(e){r.status(500).send("got error "+e.message)})}).done()});module.exports=router;