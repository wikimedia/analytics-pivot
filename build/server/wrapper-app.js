"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var path=require("path");var models_1=require("../common/models");var config_1=require("./config");var innerApp=require("./inner-app");var healthRoutes=require("./routes/health/health");var inviteUserRoutes=require("./routes/invite-user/invite-user");var loginRoutes=require("./routes/login/login");var passReset=require("./routes/pass-reset/pass-reset");var settingsRoutes=require("./routes/settings/settings");var middleware_1=require("./utils/middleware/middleware");var views_1=require("./views");function makeGuardForSettings(){return function(e,r,t){var s=e.user;if(!(s instanceof models_1.User)){r.status(403).send({error:"no user"});return}if(!s.canAccessSettings()){r.status(403).send({error:"no settings access"});return}t()}}var wrapperServer=new nike_hercules_1.HerculesServer({serverRoot:config_1.SERVER_SETTINGS.getServerRoot()});if(config_1.SERVER_SETTINGS.getTrustProxy()==="always"){wrapperServer.getApp().set("trust proxy",1)}function addSettingsRoutes(e,r){var t=makeGuardForSettings();wrapperServer.getApp().use(e,t,r);wrapperServer.getApp().use(config_1.SERVER_SETTINGS.getServerRoot()+e,t,r)}wrapperServer.addCompress();wrapperServer.getApp().use(nike_hercules_1.logAndTrack(config_1.SERVER_SETTINGS.getRequestLogFormat()));if(config_1.SERVER_SETTINGS.getStrictTransportSecurity()==="always"){wrapperServer.addHsts()}wrapperServer.addRoutes("/health",healthRoutes);wrapperServer.addStaticRoutes([path.join(__dirname,"../../build/public"),path.join(__dirname,"../../assets")]);wrapperServer.addBodyParser();var stateful=config_1.SETTINGS_MANAGER.isStateful();var userMode=config_1.SERVER_SETTINGS.getUserMode();if(config_1.SERVER_SETTINGS.needsSession()){wrapperServer.addSession(config_1.SERVER_SETTINGS.getSessionSecret(),config_1.SERVER_SETTINGS.getStrictTransportSecurity()!=="none",config_1.SERVER_SETTINGS.getSessionStore())}wrapperServer.getApp().use(function(e,r,t){e.user=null;e.version=config_1.VERSION;e.stateful=stateful;e.userMode=userMode;e.getFullSettings=function(e){if(e===void 0){e={}}return config_1.SETTINGS_MANAGER.getFullSettings(e)};t()});wrapperServer.getApp().use(function(e,r,t){var s=e.body.version;if(s&&s!==e.version){r.status(412).send({error:"incorrect version",action:"reload"});return}t()});wrapperServer.getApp().use(function(e,r,t){var s=e.body.settingsVersion;if(s&&typeof s!=="number"){r.status(400).send({error:"settings version must be a number"});return}t()});if(config_1.AUTH&&config_1.SERVER_SETTINGS.externalUsers()){wrapperServer.getApp().use(config_1.AUTH);wrapperServer.getApp().use(function(e,r,t){if(e.user&&!(e.user instanceof models_1.User)){e.user=models_1.User.fromJS(e.user)}t()})}else if(stateful&&config_1.SERVER_SETTINGS.needsLogin()){wrapperServer.addRoutes("/login",loginRoutes);wrapperServer.addRoutes("/logout",middleware_1.logout);wrapperServer.addRoutes("/invite-user",inviteUserRoutes);wrapperServer.getApp().use(middleware_1.authenticatedOnly)}else if(userMode==="all-admin"){wrapperServer.getApp().use(function(e,r,t){e.user=models_1.User.DEFAULT_ADMIN;t()})}if(stateful){addSettingsRoutes("/settings",settingsRoutes);addSettingsRoutes("/pass-reset",passReset)}if(config_1.SERVER_SETTINGS.getIframe()==="deny"){wrapperServer.getApp().use(function(e,r,t){r.setHeader("X-Frame-Options","DENY");r.setHeader("Content-Security-Policy","frame-ancestors 'none'");t()})}if(config_1.SERVER_SETTINGS.getStandaloneApp()){wrapperServer.addRoutes("/",innerApp.getApp())}else{wrapperServer.addRoutes("/pivot",innerApp.getApp())}wrapperServer.getApp().use(function(e,r,t){r.redirect("/")});if(wrapperServer.getApp().get("env")==="development"){wrapperServer.getApp().use(function(e,r,t,s){nike_hercules_1.LOGGER.error("Server Error: "+e.message);nike_hercules_1.LOGGER.error(e.stack);t.status(e.status||500);t.send(views_1.errorLayout({version:config_1.VERSION,title:"Error"},e.message,e))})}wrapperServer.getApp().use(function(e,r,t,s){nike_hercules_1.LOGGER.error("Server Error: "+e.message);nike_hercules_1.LOGGER.error(e.stack);t.status(e.status||500);t.send(views_1.errorLayout({version:config_1.VERSION,title:"Error"},e.message))});module.exports=wrapperServer;