"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Promise=require("any-promise");var chronoshift_1=require("chronoshift");var Q=require("q");var models_1=require("../../../common/models");var TimeMonitor=function(){function e(e){this.doingChecks=false;this.logger=e;this.checks={};this.regularCheckInterval=6e4;this.timekeeper=models_1.Timekeeper.EMPTY;var t=setInterval(this.doChecks.bind(this),1e3);if(t.unref)t.unref();this.doChecks()}e.prototype.addCheck=function(e,t){this.checks[e]=t;this.timekeeper=this.timekeeper.addOrUpdateTimeTagFor(e);return this.doCheck(e)};e.prototype.addStatic=function(e,t){this.timekeeper=this.timekeeper.addOrUpdateTimeTagFor(e,t)};e.prototype.removeCheck=function(e){delete this.checks[e];this.timekeeper=this.timekeeper.removeTimeTagFor(e)};e.prototype.doCheck=function(e){var t=this;var r=this.logger;var i=this.checks[e];if(!i)return Promise.resolve(null);return i().then(function(i){if(!chronoshift_1.isDate(i))throw new Error("got a non-date value from update "+i);r.log("Got the latest time for '"+e+"' ("+i.toISOString()+")");t.timekeeper=t.timekeeper.addOrUpdateTimeTagFor(e,i)}).catch(function(i){r.error("Error getting time for '"+e+"': "+i.message);t.timekeeper=t.timekeeper.touch(e)})};e.prototype.doChecks=function(){var e=this;var t=this,r=t.doingChecks,i=t.timekeeper,o=t.regularCheckInterval;if(r)return;this.doingChecks=true;var n=this.timekeeper.getTimeTagsNotUpdatedSince(new Date(i.now().valueOf()-o)).map(function(t){return e.doCheck(t.name)});Q.allSettled(n).then(function(){e.doingChecks=false})};return e}();exports.TimeMonitor=TimeMonitor;