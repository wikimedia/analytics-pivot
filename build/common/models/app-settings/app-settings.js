"use strict";Object.defineProperty(exports,"__esModule",{value:true});var beltful_1=require("@implydata/beltful");var hasOwnProperty=require("has-own-prop");var immutable_class_1=require("immutable-class");var cluster_1=require("../cluster/cluster");var collection_diff_1=require("../collection-diff/collection-diff");var collection_1=require("../collection/collection");var customization_1=require("../customization/customization");var data_cube_diff_1=require("../data-cube-diff/data-cube-diff");var data_cube_1=require("../data-cube/data-cube");var user_auth_1=require("../user-auth/user-auth");var user_1=require("../user/user");function checkNamedArrayUnique(e){var t={};for(var r=0,s=e;r<s.length;r++){var i=s[r];var a=i.name;if(t[a])throw new Error("duplicate '"+a+"'");t[a]=1}}var check;var AppSettings=function(){function e(e){var t=e.version,r=e.clusters,s=e.customization,i=e.dataCubes,a=e.linkViewConfig,n=e.collections,u=e.users,o=e.usersAuth;this.version=t||0;this.clusters=r;checkNamedArrayUnique(this.clusters);this.customization=s;this.dataCubes=i;checkNamedArrayUnique(this.dataCubes);this.linkViewConfig=a;this.collections=n;checkNamedArrayUnique(this.collections);this.users=u;if(u)checkNamedArrayUnique(u);this.usersAuth=o;if(o)checkNamedArrayUnique(o)}e.isAppSettings=function(t){return t instanceof e};e.fromJS=function(t,r){if(!r)throw new Error("AppSettings must have context");var s=t.collections;var i;if(t.clusters){i=t.clusters.map(function(e){return cluster_1.Cluster.fromJS(e)})}else if(hasOwnProperty(t,"druidHost")||hasOwnProperty(t,"brokerHost")){var a=JSON.parse(JSON.stringify(t));a.name="druid";a.type="druid";a.host=a.druidHost||a.brokerHost;i=[cluster_1.Cluster.fromJS(a)]}else{i=[]}var n=(t.dataCubes||t.dataSources||[]).map(function(e){var t=e.clusterName||e.engine;if(t!=="native"){var r=immutable_class_1.NamedArray.findByName(i,t);if(!r)throw new Error("Data cube '"+e.name+"' refers to a non existent cluster '"+t+"'")}return data_cube_1.DataCube.fromJS(e)});var u={dataCubes:n,visualizations:r.visualizations};var o=function(e){return e?collection_1.Collection.fromJS(e,u):null};var l=t.users,c=t.usersAuth;if(!c)c=[];if(l&&l.length){l=l.map(function(e){if(hasOwnProperty(e,"pass")){var t=e,r=t.name,s=t.pass,i=t.hashStrategy;delete e.pass;delete e.hashStrategy;if(!immutable_class_1.NamedArray.findByName(c,e.name)){c.push({name:r,pass:s,hashStrategy:i})}}return e})}var f={version:t.version,clusters:i,customization:customization_1.Customization.fromJS(t.customization||{}),dataCubes:n,linkViewConfig:o(t.linkViewConfig),collections:s?s.map(o).filter(Boolean):[],users:l?l.map(user_1.User.fromJS):[],usersAuth:c?c.map(user_auth_1.UserAuth.fromJS):[]};return new e(f)};e.prototype.valueOf=function(){return{version:this.version,clusters:this.clusters,customization:this.customization,dataCubes:this.dataCubes,linkViewConfig:this.linkViewConfig,collections:this.collections,users:this.users,usersAuth:this.usersAuth}};e.prototype.toJS=function(){var e={};if(this.version)e.version=this.version;e.clusters=this.clusters.map(function(e){return e.toJS()});e.customization=this.customization.toJS();e.dataCubes=this.dataCubes.map(function(e){return e.toJS()});if(this.collections.length>0)e.collections=this.collections.map(function(e){return e.toJS()});if(this.linkViewConfig)e.linkViewConfig=this.linkViewConfig.toJS();if(this.users&&this.users.length>0)e.users=this.users.map(function(e){return e.toJS()});if(this.usersAuth&&this.usersAuth.length>0)e.usersAuth=this.usersAuth.map(function(e){return e.toJS()});return e};e.prototype.toJSON=function(){return this.toJS()};e.prototype.toString=function(){return"[AppSettings v"+this.version+" dataCubes="+this.dataCubes.length+"]"};e.prototype.equals=function(t){return e.isAppSettings(t)&&this.version===t.version&&immutable_class_1.immutableArraysEqual(this.clusters,t.clusters)&&immutable_class_1.immutableEqual(this.customization,t.customization)&&immutable_class_1.immutableArraysEqual(this.dataCubes,t.dataCubes)&&immutable_class_1.immutableEqual(this.linkViewConfig,t.linkViewConfig)&&immutable_class_1.immutableArraysEqual(this.collections,t.collections)&&immutable_class_1.immutableArraysEqual(this.users,t.users)&&immutable_class_1.immutableArraysEqual(this.usersAuth,t.usersAuth)};e.prototype.toClientSettings=function(){var t=this.valueOf();t.clusters=t.clusters.map(function(e){return e.toClientCluster()});delete t.users;delete t.usersAuth;return new e(t)};e.prototype.getVersion=function(){return this.version};e.prototype.incrementVersion=function(){var t=this.valueOf();t.version++;return new e(t)};e.prototype.getCollectionsInvolvingCluster=function(e){var t=this.getDataCubesByCluster(e);return this.collections.filter(function(e){return t.some(function(t){return e.dependsOnDataCube(t.name)})})};e.prototype.getDataCubesByCluster=function(e){return this.dataCubes.filter(function(t){return t.clusterName===e})};e.prototype.getDataCubesByClusterSource=function(e,t){return this.dataCubes.filter(function(r){return r.clusterName===e&&r.source===t})};e.prototype.getDataCube=function(e){return immutable_class_1.NamedArray.findByName(this.dataCubes,e)};e.prototype.getCollection=function(e){return immutable_class_1.NamedArray.findByName(this.collections,e)};e.prototype.getCluster=function(e){return immutable_class_1.NamedArray.findByName(this.clusters,e)};e.prototype.getUsers=function(){var e=this,t=e.usersAuth,r=e.users;if(r&&r.length)return r;return t&&t.length?t.map(function(e){return e.toClientUser()}):[user_1.User.DEFAULT_ADMIN]};e.prototype.getUsersAuth=function(e){var t=this.usersAuth;if(!t)t=[];var r=user_auth_1.UserAuth.getDefaultAdmin(e);return this.getUser(r.name)?immutable_class_1.NamedArray.overrideByName(t,r):t};e.prototype.getUser=function(e){return immutable_class_1.NamedArray.findByName(this.getUsers(),e)};e.prototype.getUserAuth=function(e,t){return immutable_class_1.NamedArray.findByName(this.getUsersAuth(t),e)};e.prototype.change=function(e,t){return this["change"+beltful_1.StringUtils.firstUp(e)](t)};e.prototype.changeCustomization=function(t){var r=this.valueOf();r.customization=t;return new e(r)};e.prototype.changeClusters=function(t){var r=this.valueOf();r.clusters=t;var s=r.dataCubes.filter(function(e){if(e.clusterName==="native")return true;return immutable_class_1.NamedArray.containsByName(t,e.clusterName)});r.dataCubes=s;r.collections=r.collections.map(function(e){return e.constrainTilesToDataCubes(s)});return new e(r)};e.prototype.deleteCluster=function(e){return this.changeClusters(immutable_class_1.NamedArray.deleteByName(this.clusters,e))};e.prototype.addOrUpdateCluster=function(e){return this.changeClusters(immutable_class_1.NamedArray.overrideByName(this.clusters,e))};e.prototype.changeDataCubes=function(t){var r=this.valueOf();r.dataCubes=t;r.collections=r.collections.map(function(e){return e.constrainTilesToDataCubes(t)});return new e(r)};e.prototype.appendDataCubes=function(e){return this.changeDataCubes(immutable_class_1.NamedArray.overridesByName(this.dataCubes,e))};e.prototype.addOrUpdateDataCube=function(e){return this.changeDataCubes(immutable_class_1.NamedArray.overrideByName(this.dataCubes,e))};e.prototype.deleteDataCube=function(e){return this.changeDataCubes(immutable_class_1.NamedArray.deleteByName(this.dataCubes,e))};e.prototype.filterDataCubes=function(e){return this.changeDataCubes(this.dataCubes.filter(e))};e.prototype.getDataCubeDiffs=function(e){var t=[];immutable_class_1.NamedArray.synchronize(e,this.dataCubes,{onExit:function(e){t.push(new data_cube_diff_1.DataCubeDiff({before:e}))},onUpdate:function(e,r){t.push(new data_cube_diff_1.DataCubeDiff({before:r,after:e}))},onEnter:function(e){t.push(new data_cube_diff_1.DataCubeDiff({after:e}))}});return t};e.prototype.applyDataCubeDiff=function(e){var t=e.before,r=e.after;if(t){var s=this.getDataCube(t.name);if(!s||!s.equals(t))return null}if(r){return this.addOrUpdateDataCube(r)}else{return this.deleteDataCube(t.name)}};e.prototype.changeCollections=function(t){var r=this.valueOf();r.collections=t;return new e(r)};e.prototype.addOrUpdateCollection=function(e){return this.changeCollections(immutable_class_1.NamedArray.overrideByName(this.collections,e))};e.prototype.deleteCollection=function(e){return this.changeCollections(immutable_class_1.NamedArray.deleteByName(this.collections,e))};e.prototype.addCollectionAt=function(e,t){var r=this.collections.slice();r.splice(t,0,e);return this.changeCollections(r)};e.prototype.getCollectionDiffs=function(e){var t=[];immutable_class_1.NamedArray.synchronize(e,this.collections,{onExit:function(e){t.push(new collection_diff_1.CollectionDiff({before:e}))},onUpdate:function(e,r){t.push(new collection_diff_1.CollectionDiff({before:r,after:e}))},onEnter:function(e){t.push(new collection_diff_1.CollectionDiff({after:e}))}});return t};e.prototype.applyCollectionDiff=function(e){var t=e.before,r=e.after;if(t){var s=this.getCollection(t.name);if(!s||!s.equals(t))return null}if(r){return this.addOrUpdateCollection(r)}else{return this.deleteCollection(t.name)}};e.prototype.changeUsers=function(t){var r=this.valueOf();r.users=t;return new e(r)};e.prototype.changeUsersAuth=function(t){var r=this.valueOf();r.usersAuth=t;return new e(r)};e.prototype.addOrUpdateUser=function(e){return this.changeUsers(immutable_class_1.NamedArray.overrideByName(this.getUsers(),e))};e.prototype.appendUsers=function(e){return this.changeUsers(immutable_class_1.NamedArray.overridesByName(this.getUsers(),e))};e.prototype.deleteUser=function(e){return this.changeUsers(immutable_class_1.NamedArray.deleteByName(this.getUsers(),e)).changeUsersAuth(immutable_class_1.NamedArray.deleteByName(this.getUsersAuth(null),e))};e.prototype.updateAuthPass=function(e,t,r){var s=this;return e.updatePass(t).then(function(e){return s.changeUsersAuth(immutable_class_1.NamedArray.overrideByName(s.getUsersAuth(r),e))})};return e}();exports.AppSettings=AppSettings;check=AppSettings;AppSettings.BLANK=AppSettings.fromJS({},{visualizations:[]});