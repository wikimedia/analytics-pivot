"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var Icons=require("@implydata/little-pictures");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var granularity_1=require("../granularity/granularity");var GEO_CODES=require("./geo-codes/index");function typeToKind(e){if(!e)return e;return e.toLowerCase().replace(/_|\//g,"-").replace(/-range$/,"").replace("set-","")}function kindToType(e){if(!e)return e;return e.toUpperCase().replace("SET-","").replace("-GEO","")}var Dimension=function(e){tslib_1.__extends(t,e);function t(t){var n=e.call(this,t)||this;var r=n.name;n.title=t.title||beltful_1.StringUtils.makeTitle(r);n.expression=n.formula?plywood_1.Expression.parse(n.formula):plywood_1.$(r);n.kind=typeToKind(n.type);if(n.geo&&!n.geoEncoding){n.geoEncoding=GEO_CODES.ENCODINGS[0]}if(n.url&&typeof t.url!=="string"){throw new Error("unsupported url: "+t.url+": only strings are supported")}var i=t.granularities;if(i){if(!Array.isArray(i)||i.length!==5){throw new Error("must have list of 5 granularities in dimension '"+t.name+"'")}var a=null;n.granularities=i.map(function(e){if(a===null)a=e.op;if(e.op!==a)throw new Error("granularities must have the same type of actions");return e})}return n}t.isDimension=function(e){return e instanceof t};t.getDimension=function(e,t){if(!t)return null;return immutable_class_1.NamedArray.findByNameCI(e,t)};t.typeToKind=function(e){if(!e)return e;return e.toLowerCase().replace(/_|\//g,"-").replace(/-range$/,"")};t.fromJS=function(e){var n={name:e.name,title:e.title,group:e.group,formula:e.formula||e.expression,type:e.type||kindToType(e.kind),url:e.url};if(!n.type){n.type=(n.formula?plywood_1.Expression.fromJSLoose(n.formula).type:null)||"STRING"}var r=e.granularities;if(r){n.granularities=r.map(granularity_1.granularityFromJS)}var i=e.bucketedBy;if(i){n.bucketedBy=granularity_1.granularityFromJS(i)}var a=e.bucketingStrategy;if(a){n.bucketingStrategy=a}var o=e.sortStrategy;if(o){n.sortStrategy=o}if(e.geo){n.geo=true;if(GEO_CODES.ENCODINGS.indexOf(e.geoEncoding)>-1){n.geoEncoding=e.geoEncoding}}return new t(n)};t.prototype.toJS=function(){var t=e.prototype.toJS.call(this);if(this.granularities)t.granularities=this.granularities.map(function(e){return granularity_1.granularityToJS(e)});if(this.bucketedBy)t.bucketedBy=granularity_1.granularityToJS(this.bucketedBy);return t};t.prototype.canAutoBucket=function(){var e=this.getBucketingStrategy();return this.isContinuous()&&e!==t.DEFAULT_NO_BUCKET&&e!==t.NEVER_BUCKET};t.prototype.isBucketable=function(){return this.isContinuous()&&this.getBucketingStrategy()!==t.NEVER_BUCKET};t.prototype.getBucketingStrategy=function(){var e=this,n=e.bucketingStrategy,r=e.kind;if(!n&&r==="time")return t.ALWAYS_BUCKET;return n||t.DEFAULT_BUCKET};t.prototype.canHaveNoBucket=function(){return this.getBucketingStrategy()!==t.ALWAYS_BUCKET};t.prototype.isContinuous=function(){var e=this.type;return e==="TIME"||e==="NUMBER"};t.prototype.toEffectiveExpression=function(){return this.expression.cast(this.type)};t.prototype.changeType=function(e){var n=this.valueOf();n.type=e;return new t(n)};t.prototype.getComboType=function(){var e=this,t=e.type,n=e.geo;if(n)return"Geo";return t.toLowerCase().replace(/^\w|\/\w/g,function(e){return e.toUpperCase()})};t.prototype.changeComboType=function(e){var n=this.valueOf();n.geo=false;switch(e){case"Boolean":case"String":case"Set/String":case"Number":case"Time":n.type=e.toUpperCase();break;case"Geo":n.type="STRING";n.geo=true;break}return new t(n)};t.prototype.getFormula=function(){return this.formula||this.expression.toString()};t.prototype.getColumn=function(){if(this.expression instanceof plywood_1.RefExpression){return this.expression.name}return null};t.prototype.changeColumn=function(e){return this.changeFormula(plywood_1.$(e).toString())};t.prototype.getKind=function(){return this.kind};t.prototype.getGranularities=function(){if(!this.isContinuous())return null;return this.granularities||granularity_1.getGranularities(this.kind,this.bucketedBy,false,this.canHaveNoBucket())};t.prototype.isGeo=function(){return this.geo};t.prototype.isDerived=function(){return!this.expression.equals(plywood_1.$(this.name))};t.prototype.getCoordinatesConverter=function(){if(!this.isGeo())return null;var e=GEO_CODES.getCodes(this.geoEncoding);return function(t){return e[t]}};t.prototype.usesAttribute=function(e){return this.expression.some(function(t){if(t instanceof plywood_1.RefExpression){return t.name===e}else{return null}})};t.prototype.fromColumn=function(){if(this.expression instanceof plywood_1.RefExpression){return this.expression.name}return null};t.prototype.isTime=function(){return this.kind==="time"};t.prototype.isBoolean=function(){return this.kind==="boolean"};t.prototype.guessName=function(){return beltful_1.StringUtils.makeUrlSafeName(this.formula)};t.prototype.guessTitle=function(){return beltful_1.StringUtils.makeTitle(this.name)};t.prototype.getIcon=function(){if(this.isGeo())return Icons.DIM_GEO;if(this.isTime())return Icons.DIM_TIME;if(this.isContinuous())return Icons.DIM_NUMBER;if(this.isBoolean())return Icons.DIM_BOOLEAN;return Icons.DIM_STRING};return t}(immutable_class_1.BaseImmutable);Dimension.GEO_ENCODINGS=GEO_CODES.ENCODINGS;Dimension.ALWAYS_BUCKET="alwaysBucket";Dimension.DEFAULT_BUCKET="defaultBucket";Dimension.DEFAULT_NO_BUCKET="defaultNoBucket";Dimension.NEVER_BUCKET="neverBucket";Dimension.COMBO_TYPES_NORMAL=[{label:"Boolean",value:"Boolean"},{label:"String",value:"String"},{label:"Set/String",value:"Set/String"},{label:"Number",value:"Number"},{label:"Time",value:"Time"},{label:"Geo",value:"Geo"}];Dimension.COMBO_TYPES_UNSPLITABLE=[{label:"String",value:"String"},{label:"Number",value:"Number"},{label:"Unique",value:"Unique"},{label:"Theta",value:"Theta"},{label:"Histogram",value:"Histogram"}];Dimension.BUCKETING_STRATEGIES=[{label:"Always bucket",value:Dimension.ALWAYS_BUCKET},{label:"Default bucket",value:Dimension.DEFAULT_BUCKET},{label:"Default donâ€™t bucket",value:Dimension.DEFAULT_NO_BUCKET},{label:"Never bucket",value:Dimension.NEVER_BUCKET}];Dimension.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"group",defaultValue:null},{name:"formula",defaultValue:null},{name:"type"},{name:"url",defaultValue:null},{name:"granularities",defaultValue:[],equal:immutable_class_1.immutableArraysEqual},{name:"bucketedBy",defaultValue:null,equal:granularity_1.granularityEquals},{name:"bucketingStrategy",defaultValue:null,possibleValues:["defaultBucket","defaultNoBucket","neverBucket","alwaysBucket"]},{name:"sortStrategy",defaultValue:null},{name:"geo",defaultValue:false},{name:"geoEncoding",defaultValue:null,possibleValues:GEO_CODES.ENCODINGS}];exports.Dimension=Dimension;immutable_class_1.BaseImmutable.finalize(Dimension);