"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var measure_filter_1=require("../measure-filter/measure-filter");var MeasureFormula=function(e){tslib_1.__extends(r,e);function r(r){if(r===void 0){r={}}return e.call(this,r)||this}r.fromJS=function(e){return new r(immutable_class_1.BaseImmutable.jsToValue(r.PROPERTIES,e))};r.fromFormula=function(e){return r.fromExpression(plywood_1.Expression.parse(e))};r.fromExpression=function(e){if(e instanceof plywood_1.CountExpression){if(!r.isMainDataReference(e.operand))return null;var a=r.fromJS({aggregation:"count",column:null,filter:measure_filter_1.MeasureFilter.fromExpression(e.operand.expression)});if(a.hasSimpleFilter())return a}if(e instanceof plywood_1.SumExpression||e instanceof plywood_1.MinExpression||e instanceof plywood_1.MaxExpression||e instanceof plywood_1.AverageExpression||e instanceof plywood_1.CountDistinctExpression||e instanceof plywood_1.QuantileExpression){if(!r.isMainDataReference(e.operand))return null;var n=e.expression;if(!(n instanceof plywood_1.RefExpression))return null;var l=void 0;if(e instanceof plywood_1.QuantileExpression){if(e.value===.5){l="median"}else if(e.value===.98){l="98th"}else{return null}}else{l=e.op}var a=r.fromJS({aggregation:l,column:n.name,filter:measure_filter_1.MeasureFilter.fromExpression(e.operand.expression)});if(a.hasSimpleFilter())return a}return null};r.isMainDataReference=function(e){var r=plywood_1.$("main");return e.equals(r)||e instanceof plywood_1.FilterExpression&&e.operand.equals(r)};r.prototype.toFormula=function(){return this.toExpression().toString()};r.prototype.toExpression=function(){var e=plywood_1.$("main");if(this.filter){e=e.filter(this.filter.toString())}var r=this.aggregation;var a=null;if(r==="median"||r==="98th"){a=r==="median"?.5:.98;r="quantile"}var n=plywood_1.Expression.fromJS({op:r,expression:this.column?plywood_1.$(this.column):null,value:a});return e.performAction(n)};r.prototype.canHaveColumn=function(){return this.aggregation!=="count"};r.prototype.changeAggregation=function(e){var a=this.valueOf();a.aggregation=e;if(a.aggregation!=="count"&&!a.column){a.column=this.possibleColumns[0]}return new r(a)};r.prototype.hasSimpleFilter=function(){if(!this.filter)return true;return this.filter.isSimpleFilter()};r.prototype.removeFilter=function(){var e=this.valueOf();e.filter=null;return new r(e)};r.prototype.createDefaultFilter=function(e){var r=measure_filter_1.MeasureFilter.fromJS({column:e,operator:measure_filter_1.MeasureFilter.OPERATORS[0].value,value:""});return this.changeFilter(r)};return r}(immutable_class_1.BaseImmutable);MeasureFormula.AGGREGATIONS=[{label:"Count",value:"count"},{label:"Sum",value:"sum"},{label:"Average",value:"average"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Unique values",value:"countDistinct"},{label:"Median",value:"median"},{label:"98th percentile",value:"98th"}];MeasureFormula.DEFAULT_AGGREGATION=MeasureFormula.AGGREGATIONS[1].value;MeasureFormula.PROPERTIES=[{name:"aggregation",defaultValue:"count"},{name:"column",defaultValue:null},{name:"possibleColumns",defaultValue:[]},{name:"filter",immutableClass:measure_filter_1.MeasureFilter,defaultValue:null}];exports.MeasureFormula=MeasureFormula;immutable_class_1.BaseImmutable.finalize(MeasureFormula);