"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var strings_1=require("../strings");function toSet(e){return e instanceof plywood_1.Set?e:plywood_1.Set.fromJS([e])}var FilterClause=function(e){tslib_1.__extends(t,e);function t(t){var n=e.call(this,t)||this;var a=Number(Boolean(n.values))+Number(Boolean(n.dynamic))+Number(Boolean(n.search));if(a!==1)throw new Error("must have exactly one of 'values', 'dynamic', and 'search'");if((n.action==="match"||n.action==="contains")!==Boolean(n.search)){throw new Error("match / contains must go with search")}return n}t.isFilterClause=function(e){return e instanceof t};t.evaluate=function(e,n,a,r){if(!e)return null;var i=e.getLiteralValue();if(i instanceof plywood_1.Set){return i.extent()}var s=chronoshift_1.minute.ceil(a||n,r);var l={};l[t.NOW_REF_NAME]=n;l[t.MAX_TIME_REF_NAME]=s;return e.defineEnvironment({timezone:r}).getFn()(l)};t.fromExpression=function(e){var n=false;if(e instanceof plywood_1.NotExpression){e=e.operand;n=true}var a;if(e instanceof plywood_1.ChainableExpression){if(e.operand instanceof plywood_1.RefExpression){a=e.operand.name}else{throw new Error("must be a ref "+e.operand)}}else{throw new Error("must be a chainable expression "+e)}if(e instanceof plywood_1.InExpression||e instanceof plywood_1.OverlapExpression){var r=e.expression;var i=r.getLiteralValue();var s=e.op;return new t({action:s==="in"?"overlap":s,dimension:a,values:i?toSet(i):null,dynamic:i?null:r,exclude:n})}if(e instanceof plywood_1.ContainsExpression){return new t({action:"contains",dimension:a,search:e.expression.getLiteralValue(),exclude:n})}if(e instanceof plywood_1.MatchExpression){return new t({action:"match",dimension:a,search:e.regexp,exclude:n})}throw new Error("invalid expression "+e.toString())};t.fromSingleValue=function(e,n){return new t({dimension:e,values:plywood_1.Set.fromJS([n])})};t.fromJS=function(e){return new t(immutable_class_1.BaseImmutable.jsToValue(t.PROPERTIES,e))};t.prototype.toString=function(){return"[FilterClause: "+this.dimension+"]"};t.prototype.changeValues=function(e){var n=this.valueOf();n.values=e;delete n.dynamic;delete n.search;return new t(n)};t.prototype.changeDynamic=function(e){var n=this.valueOf();delete n.values;n.dynamic=e;delete n.search;return new t(n)};t.prototype.changeSearch=function(e){var n=this.valueOf();delete n.values;delete n.dynamic;n.search=e;return new t(n)};t.prototype.toExpression=function(e){var t=this,n=t.dimension,a=t.action,r=t.values,i=t.dynamic,s=t.search;var l=immutable_class_1.NamedArray.findByName(e,n);if(!l)throw new Error("filter clause on unknown dimension '"+n+"'");var o=l.expression;var u=null;if(r||i){u=o.overlap(r||i)}else if(a==="contains"){u=o.contains(plywood_1.r(s),"ignoreCase")}else if(a==="match"){u=o.match(s)}else{throw new Error("should never get here")}if(this.exclude)u=u.not();return u};t.prototype.getLiteralSet=function(){return this.values};t.prototype.getExtent=function(){var e=this.values;return e?e.extent():null};t.prototype.isLessThanFullDay=function(){var e=this.getExtent();if(!e)return false;return e.end.valueOf()-e.start.valueOf()<chronoshift_1.day.canonicalLength};t.prototype.evaluate=function(e,n,a){var r=this.dynamic;if(!r)return this;return this.changeValues(toSet(t.evaluate(r,e,n,a)))};return t}(immutable_class_1.BaseImmutable);FilterClause.NOW_REF_NAME="n";FilterClause.MAX_TIME_REF_NAME="m";FilterClause.$maxTime=plywood_1.$(FilterClause.MAX_TIME_REF_NAME);FilterClause.$now=plywood_1.$(FilterClause.NOW_REF_NAME);FilterClause.LATEST_PRESETS=[{name:"1H",selection:FilterClause.$maxTime.timeRange("PT1H",-1),label:strings_1.STRINGS.latest+" "+strings_1.STRINGS.hour},{name:"6H",selection:FilterClause.$maxTime.timeRange("PT6H",-1),label:strings_1.STRINGS.latest+" 6 "+strings_1.STRINGS.hours},{name:"1D",selection:FilterClause.$maxTime.timeRange("P1D",-1),label:strings_1.STRINGS.latest+" "+strings_1.STRINGS.day},{name:"7D",selection:FilterClause.$maxTime.timeRange("P1D",-7),label:strings_1.STRINGS.latest+" 7 "+strings_1.STRINGS.days},{name:"30D",selection:FilterClause.$maxTime.timeRange("P1D",-30),label:strings_1.STRINGS.latest+" 30 "+strings_1.STRINGS.days}];FilterClause.CURRENT_PRESETS=[{name:"D",selection:FilterClause.$now.timeBucket("P1D"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.day},{name:"W",selection:FilterClause.$now.timeBucket("P1W"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.week},{name:"M",selection:FilterClause.$now.timeBucket("P1M"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.month},{name:"Q",selection:FilterClause.$now.timeBucket("P3M"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.quarter},{name:"Y",selection:FilterClause.$now.timeBucket("P1Y"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.year}];FilterClause.PREVIOUS_PRESETS=[{name:"D",selection:FilterClause.$now.timeFloor("P1D").timeRange("P1D",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.day},{name:"W",selection:FilterClause.$now.timeFloor("P1W").timeRange("P1W",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.week},{name:"M",selection:FilterClause.$now.timeFloor("P1M").timeRange("P1M",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.month},{name:"Q",selection:FilterClause.$now.timeFloor("P3M").timeRange("P3M",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.quarter},{name:"Y",selection:FilterClause.$now.timeFloor("P1Y").timeRange("P1Y",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.year}];FilterClause.PROPERTIES=[{name:"action",defaultValue:"overlap"},{name:"dimension"},{name:"values",immutableClass:plywood_1.Set,defaultValue:null},{name:"dynamic",immutableClass:plywood_1.Expression,defaultValue:null},{name:"search",defaultValue:null},{name:"exclude",defaultValue:false}];exports.FilterClause=FilterClause;immutable_class_1.BaseImmutable.finalize(FilterClause);