"use strict";Object.defineProperty(exports,"__esModule",{value:true});var beltful_1=require("@implydata/beltful");var chronoshift_1=require("chronoshift");var hasOwnProperty=require("has-own-prop");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var MENU_LENGTH=5;function convertStringNumberToNumber(e){if(typeof e==="string"&&!isNaN(Number(e)))return parseFloat(e);return e}function makeCheckpoint(e,r){function t(r,t){return r>e||t>e}return{returnValue:granularityFromJS(r),check:t}}function makeNumberBuckets(e,r,t){var n=[];var i=Math.log(e)/Math.LN10;var u=beltful_1.NumberUtils.getNumberOfWholeDigits(e);while(n.length<=r){if(!t){var a=beltful_1.NumberUtils.toSignificantDigits(5*Math.pow(10,i-1),u);n.push(granularityFromJS(a))}if(n.length>=r)break;var o=beltful_1.NumberUtils.toSignificantDigits(Math.pow(10,i),u);n.push(granularityFromJS(o));i++}return n}function days(e){return e*chronoshift_1.day.canonicalLength}function hours(e){return e*chronoshift_1.hour.canonicalLength}function minutes(e){return e*chronoshift_1.minute.canonicalLength}function years(e){return e*chronoshift_1.year.canonicalLength}var TimeHelper=function(){function e(){}return e}();TimeHelper.dimensionKind="time";TimeHelper.minGranularity=granularityFromJS("PT1M");TimeHelper.defaultGranularity=granularityFromJS("P1D");TimeHelper.supportedGranularities=function(){return["PT1S","PT1M","PT5M","PT15M","PT1H","PT6H","PT8H","PT12H","P1D","P1W","P1M","P3M","P6M","P1Y","P2Y"].map(granularityFromJS)};TimeHelper.checkers=[makeCheckpoint(days(95),"P1W"),makeCheckpoint(days(8),"P1D"),makeCheckpoint(hours(8),"PT1H"),makeCheckpoint(hours(3),"PT5M")];TimeHelper.coarseCheckers=[makeCheckpoint(years(2),"P6M"),makeCheckpoint(days(95),"P1M"),makeCheckpoint(days(20),"P1W"),makeCheckpoint(days(6),"P1D"),makeCheckpoint(days(2),"PT12H"),makeCheckpoint(hours(23),"PT6H"),makeCheckpoint(hours(3),"PT1H"),makeCheckpoint(minutes(30),"PT5M")];TimeHelper.defaultGranularities=TimeHelper.checkers.map(function(e){return e.returnValue}).concat(TimeHelper.minGranularity).reverse();TimeHelper.coarseGranularities=TimeHelper.coarseCheckers.map(function(e){return e.returnValue}).concat(TimeHelper.minGranularity).reverse();TimeHelper.get={bucketSize:function(e){return e.duration.getCanonicalLength()},bucketUnit:function(e){return e.duration},fromBucketUnit:function(e){return plywood_1.Expression._.timeBucket(e)},startValue:function(e){return e.start.valueOf()},endValue:function(e){return e.end.valueOf()},toString:function(e){return e.duration.toString()},lineChartTicks:function(e,r){var t=e.start,n=e.end;var i=getBestBucketUnitForRange(e,true);return i.materialize(t,n,r)},newBucketSize:function(e,r){return plywood_1.Expression._.timeBucket(r.duration,e.timezone)}};exports.TimeHelper=TimeHelper;var NumberHelper=function(){function e(){}return e}();NumberHelper.dimensionKind="number";NumberHelper.minGranularity=granularityFromJS(1);NumberHelper.defaultGranularity=granularityFromJS(10);NumberHelper.checkers=[makeCheckpoint(5e3,1e3),makeCheckpoint(500,100),makeCheckpoint(100,10),makeCheckpoint(1,1),makeCheckpoint(.1,.1)];NumberHelper.defaultGranularities=NumberHelper.checkers.map(function(e){return granularityFromJS(e.returnValue)}).reverse();NumberHelper.coarseGranularities=null;NumberHelper.coarseCheckers=[makeCheckpoint(5e5,5e4),makeCheckpoint(5e4,1e4),makeCheckpoint(5e3,5e3),makeCheckpoint(1e3,1e3),makeCheckpoint(100,100),makeCheckpoint(10,10),makeCheckpoint(1,1),makeCheckpoint(.1,.1)];NumberHelper.supportedGranularities=function(e){return makeNumberBuckets(getBucketSize(e),10)};NumberHelper.get={bucketSize:function(e){return e.size},bucketUnit:function(e){return e.size},fromBucketUnit:function(e){return plywood_1.Expression._.numberBucket(e,0)},startValue:function(e){return e.start},endValue:function(e){return e.end},toString:function(e){return e.size.toString()},lineChartTicks:function(e,r){var t=e,n=t.start,i=t.end;var u=getBestBucketUnitForRange(e,true);var a=[];var o=Math.round(n*u)/u;while(o<=i){a.push(o);o+=u}return a},newBucketSize:function(e,r){return plywood_1.Expression._.numberBucket(r.size,e.offset)}};exports.NumberHelper=NumberHelper;function getHelper(){return{kind:function(e){return e==="time"?TimeHelper:NumberHelper},bucketUnit:function(e){return e instanceof chronoshift_1.Duration?TimeHelper:NumberHelper},range:function(e){return e instanceof plywood_1.TimeRange?TimeHelper:NumberHelper},granularity:function(e){return e instanceof plywood_1.TimeBucketExpression?TimeHelper:NumberHelper}}}var getBucketSize=function(e){return getHelper().granularity(e).get.bucketSize(e)};var getBucketUnit=function(e){return getHelper().granularity(e).get.bucketUnit(e)};var bucketUnitToGranularity=function(e){return getHelper().bucketUnit(e).get.fromBucketUnit(e)};var startValue=function(e){return getHelper().range(e).get.startValue(e)};var endValue=function(e){return getHelper().range(e).get.endValue(e)};function findBestMatch(e,r){var t=beltful_1.ArrayUtils.findExactIndex(e,r,getBucketSize);if(t!==-1){return e[t]}var n=beltful_1.ArrayUtils.findFirstBiggerIndex(e,r,getBucketSize);if(n!==-1){return e[n]}return e[beltful_1.ArrayUtils.findMaxValueIndex(e,getBucketSize)]}function generateGranularitySet(e,r,t){var n=beltful_1.ArrayUtils.findFirstBiggerIndex(e,r,getBucketSize);var i=e.slice(n,n+MENU_LENGTH);if(beltful_1.ArrayUtils.findExactIndex(i,r,getBucketSize)===-1){i=[r].concat(i.slice(0,i.length-1))}return i}function granularityFromJS(e){e=convertStringNumberToNumber(e);if(typeof e==="number")return plywood_1.Expression._.numberBucket(e);if(typeof e==="string")return plywood_1.Expression._.timeBucket(e);if(typeof e==="object"){if(!hasOwnProperty(e,"action")&&!hasOwnProperty(e,"op")){throw new Error("could not recognize object as action")}return plywood_1.Expression.fromJS(e)}throw new Error("input should be of type number, string, or expression")}exports.granularityFromJS=granularityFromJS;function granularityToString(e){if(!e)return"none";return getHelper().granularity(e).get.toString(e)}exports.granularityToString=granularityToString;function granularityEquals(e,r){return immutable_class_1.immutableEqual(e,r)}exports.granularityEquals=granularityEquals;function granularityToJS(e){var r=e.toJS();if(r.op==="timeBucket"){if(Object.keys(r).length===2)return r.duration}if(r.op==="numberBucket"){if(Object.keys(r).length===2)return r.size}return r}exports.granularityToJS=granularityToJS;function updateBucketSize(e,r){if(!r)return null;if(!e)return r;return getHelper().granularity(e).get.newBucketSize(e,r)}exports.updateBucketSize=updateBucketSize;function getGranularities(e,r,t,n){var i=getHelper().kind(e);var u=i.defaultGranularities,a=i.coarseGranularities;if(!r){return t&&a?a:u}var o=i.supportedGranularities(r);return generateGranularitySet(o,r,n)}exports.getGranularities=getGranularities;function getDefaultGranularityForKind(e,r,t){if(r)return r;if(t)return t[2];return getHelper().kind(e).defaultGranularity}exports.getDefaultGranularityForKind=getDefaultGranularityForKind;function getBestGranularityForRange(e,r,t,n){return bucketUnitToGranularity(getBestBucketUnitForRange(e,r,t,n))}exports.getBestGranularityForRange=getBestGranularityForRange;function getBestBucketUnitForRange(e,r,t,n){var i=Math.abs(endValue(e)-startValue(e));var u=getHelper().range(e);var a=t?getBucketSize(t):0;var o=r&&u.coarseCheckers?u.coarseCheckers:u.checkers;for(var l=0;l<o.length;l++){var c=o[l],s=c.returnValue,p=c.check;if(p(i,a)){if(t){var g=n||getGranularities(u.dimensionKind,t);var f=beltful_1.ArrayUtils.findBiggerClosestToIdeal(g,t,s,getBucketSize);if(f===null)return getBucketUnit(u.defaultGranularity);return getBucketUnit(f)}else{if(!n)return getBucketUnit(s);return getBucketUnit(findBestMatch(n,s))}}}var m=n?n[beltful_1.ArrayUtils.findMinValueIndex(n,getBucketSize)]:u.minGranularity;var k=a>getBucketSize(m)?t:m;return getBucketUnit(k)}exports.getBestBucketUnitForRange=getBestBucketUnitForRange;function getLineChartTicks(e,r){return getHelper().range(e).get.lineChartTicks(e,r)}exports.getLineChartTicks=getLineChartTicks;