"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var essence_1=require("../essence/essence");var split_combine_1=require("../split-combine/split-combine");var timekeeper_1=require("../timekeeper/timekeeper");function withholdSplit(t,e,n){return t.filter(function(t,i){return i===n||!t.sameOnDimension(e)})}function swapSplit(t,e,n,i){return t.map(function(t,r){return r===i||!t.sameOnDimension(e)?t:n})}var check;var Splits=function(){function t(t){this.splitCombines=t}t.isSplits=function(e){return e instanceof t};t.fromSplitCombine=function(e){return new t([e])};t.fromJS=function(e,n){if(!Array.isArray(e))e=[e];return new t(e.map(function(t){return split_combine_1.SplitCombine.fromJS(t,n)}))};t.prototype.valueOf=function(){return this.splitCombines};t.prototype.toJS=function(){return this.splitCombines.map(function(t){return t.toJS()})};t.prototype.toJSON=function(){return this.toJS()};t.prototype.toString=function(){return this.splitCombines.map(function(t){return t.toString()}).join(",")};t.prototype.equals=function(e){return t.isSplits(e)&&immutable_class_1.immutableArraysEqual(this.splitCombines,e.splitCombines)};t.prototype.replaceByIndex=function(e,n){var i=this.splitCombines;if(i.length===e)return this.insertByIndex(e,n);var r=i[e];i=i.map(function(t,i){return i===e?n:t});i=swapSplit(i,n,r,e);return new t(i)};t.prototype.insertByIndex=function(e,n){var i=this.splitCombines;i=immutable_class_1.SimpleArray.insertIndex(i,e,n);i=withholdSplit(i,n,e);return new t(i)};t.prototype.addSplit=function(t){var e=this.splitCombines;return this.insertByIndex(e.length,t)};t.prototype.removeSplit=function(e){return new t(this.splitCombines.filter(function(t){return t.dimension!==e.dimension}))};t.prototype.changeSortAction=function(e){return new t(this.splitCombines.map(function(t){return t.changeSortAction(e)}))};t.prototype.changeSortActionFromNormalized=function(e){return new t(this.splitCombines.map(function(t){return t.changeSortActionFromNormalized(e)}))};t.prototype.getTitle=function(t){return this.splitCombines.map(function(e){return e.getDimension(t).title}).join(", ")};t.prototype.getSplitDimensions=function(t){return this.splitCombines.map(function(e){return e.getDimension(t)})};t.prototype.length=function(){return this.splitCombines.length};t.prototype.forEach=function(t,e){this.splitCombines.forEach(t,e)};t.prototype.get=function(t){return this.splitCombines[t]};t.prototype.first=function(){return this.splitCombines[0]};t.prototype.last=function(){return this.splitCombines[this.splitCombines.length-1]};t.prototype.contains=function(t){return immutable_class_1.SimpleArray.contains(this.splitCombines,function(e){return e.equals(t)})};t.prototype.findSplitForDimension=function(t){return this.splitCombines.find(function(e){return e.dimension===t})};t.prototype.hasSplitOn=function(t){return Boolean(this.findSplitForDimension(t))};t.prototype.replace=function(e,n){var i=e.dimension;return new t(this.splitCombines.map(function(t){return t.dimension===i?n:t}))};t.prototype.map=function(e,n){return new t(this.splitCombines.map(e,n))};t.prototype.toArray=function(){return this.splitCombines};t.prototype.isSubsetOf=function(t){if(!t)return false;return t.length()>this.length()&&this.splitCombines.every(function(e){return t.contains(e)})};t.prototype.initializeGivenFilter=function(e,n,i){var r=e.getSpecificFilter(timekeeper_1.Timekeeper.globalNow(),timekeeper_1.Timekeeper.globalNow(),chronoshift_1.Timezone.UTC);return new t(this.splitCombines.map(function(t){var e=immutable_class_1.NamedArray.findByName(n,t.dimension);return!t.isBucketed()||!t.sortAction?split_combine_1.SplitCombine.fromDimensionAndFilterAndMeasure(e,r,i):t}))};t.prototype.recalculateBucketsWithFilterChange=function(e,n,i){var r=false;var o=this.splitCombines.map(function(t){if(!t.isBucketed())return t;var o=immutable_class_1.NamedArray.findByName(i,t.dimension);if(!o)return t;if(!e.differentForDimension(n,o.name))return t;var s=split_combine_1.SplitCombine.calculateBucketGivenFilter(n,o);var u=t.changeBucketAction(s);if(!u.equals(t))r=true;return u});return r?new t(o):this};t.prototype.constrainToDimensionsAndMeasures=function(e,n){function i(t){if(!t.getDimension(e))return false;var i=t.sortAction.refName();if(!immutable_class_1.NamedArray.findByName(e,i)&&!immutable_class_1.NamedArray.findByName(n,i))return false;return true}var r=false;var o=[];this.splitCombines.forEach(function(t){if(i(t)){o.push(t)}else{r=true}});return r?new t(o):this};t.prototype.timezoneDependant=function(){return this.splitCombines.some(function(t){return t.timezoneDependant()})};t.prototype.changeSortIfOnMeasure=function(e,n){var i=false;var r=this.splitCombines.map(function(t){var r=t.sortAction;if(!r||r.refName()!==e)return t;i=true;return t.changeSortAction(plywood_1.Expression._.sort(plywood_1.$(n),r.direction))});return i?new t(r):this};t.prototype.getCommonSort=function(){var t=this.splitCombines;var e=null;for(var n=0,i=t;n<i.length;n++){var r=i[n];var o=r.getNormalizedSortAction();if(e){if(!e.equals(o))return null}else{e=o}}return e};t.prototype.getStrategyForSplitChange=function(t){var e=this.splitCombines;var n=t.splitCombines;var i=function(t){var i=e[t];if(n.find(function(t){return t.sameOnDimension(i)}))return{value:essence_1.VisStrategy.UnfairGame}};for(var r=0;r<e.length;r++){var o=i(r);if(typeof o==="object")return o.value}return essence_1.VisStrategy.FairGame};t.prototype.sameOnDimensions=function(t){var e=this.splitCombines;var n=t.splitCombines;if(e.length!==n.length)return false;for(var i=0;i<e.length;i++){var r=e[i];var o=n[i];if(!o)return false;if(!o.sameOnDimension(r))return false}return true};t.prototype.isBucketedFollowedByUnbucketed=function(){return this.length()===2&&this.first().isBucketed()&&!this.get(1).isBucketed()};return t}();exports.Splits=Splits;check=Splits;Splits.EMPTY=new Splits([]);