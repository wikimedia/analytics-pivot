"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var chronoshift_1=require("chronoshift");var hasOwnProperty=require("has-own-prop");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var dimension_1=require("../dimension/dimension");var filter_clause_1=require("../filter-clause/filter-clause");var filter_1=require("../filter/filter");var measure_1=require("../measure/measure");var refresh_rule_1=require("../refresh-rule/refresh-rule");var splits_1=require("../splits/splits");var MAX_TIME="maxTime";function formatTimeDiff(e){e=Math.round(Math.abs(e)/1e3);if(e<60)return"less than 1 minute";e=Math.floor(e/60);if(e===1)return"1 minute";if(e<60)return e+" minutes";e=Math.floor(e/60);if(e===1)return"1 hour";if(e<=24)return e+" hours";e=Math.floor(e/24);return e+" days"}function checkUnique(e,t,r){var i={};var n={};if(e){e.forEach(function(e){var t=e.name.toLowerCase();if(i[t]){throw new Error("duplicate dimension name '"+e.name+"' found in data cube: '"+r+"'")}i[t]=e})}if(t){t.forEach(function(e){var t=e.name.toLowerCase();if(n[t]){throw new Error("duplicate measure name '"+e.name+"' found in data cube: '"+r+"'")}if(i[t]){throw new Error("name '"+e.name+"' found in both dimensions and measures in data cube: '"+r+"'")}n[t]=e})}}var INTERESTING_NATIVE_TYPE={__time:true,approximateHistogram:true,hyperUnique:true,thetaSketch:true};function measuresFromLongForm(e){var t=e.metricColumn,r=e.measures,i=e.possibleAggregates;var n={};for(var a in i){if(!hasOwnProperty(i,a))continue;n[a]=plywood_1.Expression.fromJSLoose(i[a])}return r.map(function(e){if(hasOwnProperty(e,"name")){return measure_1.Measure.fromJS(e)}var r=e.title;if(!r){throw new Error("must have title in longForm value")}var i=e.value;var a=e.aggregate;if(!a){throw new Error("must have aggregates in longForm value")}var s=n[a];if(!s)throw new Error("can not find aggregate "+a+" for value "+i);var u=beltful_1.StringUtils.makeUrlSafeName(a+"_"+i);return new measure_1.Measure({name:u,title:r,units:e.units,formula:s.substitute(function(e){if(e instanceof plywood_1.RefExpression&&e.name==="filtered"){return plywood_1.$("main").filter(plywood_1.$(t).is(plywood_1.r(i)))}return null}).toString()})})}function filterFromLongForm(e){var t=e.metricColumn,r=e.measures;var i=[];for(var n=0,a=r;n<a.length;n++){var s=a[n];if(hasOwnProperty(s,"aggregate"))i.push(s.value)}return plywood_1.$(t).in(i).simplify()}var DataCube=function(e){tslib_1.__extends(t,e);function t(t){var r=e.call(this,t)||this;var i=r,n=i.name,a=i.dimensions,s=i.measures;if(typeof n!=="string")throw new Error("Data cube must have a name");if(!r.source)r.source=n;r.subsetExpression=t.subsetFormula?plywood_1.Expression.fromJSLoose(t.subsetFormula):plywood_1.Expression.TRUE;checkUnique(a,s,n);r._validateDefaults();return r}t.isDataCube=function(e){return e instanceof t};t.getPossibleTimeDimension=function(e){for(var r=0,i=e;r<i.length;r++){var n=i[r];if(n.expression.equals(plywood_1.$("__time")))return n.name}for(var a=0,s=e;a<s.length;a++){var n=s[a];if(n.type==="TIME")return n.name}return t.NO_SPECIAL_TIME_DIMENSION};t.processMaxTimeQuery=function(e){var t=new Date(e.data[0][MAX_TIME]);if(isNaN(t))return null;return t};t.putSpecialTimeOnTop=function(e){var t=immutable_class_1.NamedArray.findByName(e,"__time");if(!t)return e;return[t].concat(e.filter(function(e){return e.name!=="__time"}))};t.suggestDimensions=function(e){return t.putSpecialTimeOnTop(e).map(function(e){if(e.name==="count"||e.unsplitable)return null;var t=e.name,r=e.type;return new dimension_1.Dimension({name:beltful_1.StringUtils.makeUrlSafeName(t),type:r||"STRING",formula:plywood_1.$(t).toString()})}).filter(Boolean)};t.suggestMeasures=function(e){var t=[];var r=false;for(var i=0,n=e;i<n.length;i++){var a=n[i];var s=measure_1.Measure.measuresFromAttribute(a);s.forEach(function(e){if(e.name==="count"||e.name==="sum_count"){r=true;t.unshift(e)}else{t.push(e)}})}if(!r){t.unshift(new measure_1.Measure({name:"count",title:"Count",formula:"$main.count()"}))}return t};t.fromClusterAndSource=function(e,r,i){return t.fromJS({name:e,title:beltful_1.StringUtils.makeTitle(i),clusterName:r.name,source:i})};t.fromJS=function(e){var r=e.clusterName||e.engine;var i=e.introspection;var n=e.defaultSplits;var a=e.options;if(a){if(a.skipIntrospection){if(!i)i="none";delete a.skipIntrospection}if(a.disableAutofill){if(!i)i="no-autofill";delete a.disableAutofill}if(a.defaultSplitDimension){a.defaultSplits=a.defaultSplitDimension;delete a.defaultSplitDimension}if(a.defaultSplits){if(!n)n=a.defaultSplits;delete a.defaultSplits}}var s=e.dimensions||[];var u=s.filter(function(e){return e.unsplitable}).map(function(e){var t={name:e.name,type:"NUMBER",maker:e.maker,unsplitable:true};if(e.special){t.special=e.special;t.type="NULL"}return plywood_1.AttributeInfo.fromJS(t)});var o=s.filter(function(e){return!e.unsplitable}).map(function(e){return dimension_1.Dimension.fromJS(e)});var l=(e.measures||[]).map(function(e){return measure_1.Measure.fromJS(e)});var m=e.attributes||u;m.forEach(function(e){if(e.type==="STRING"&&e.unsplitable&&!e.nativeType){e.type=e.special?"NULL":"NUMBER"}});var f=plywood_1.AttributeInfo.fromJSs(m);var p=e.attributeOverrides||(e.options||{}).attributeOverrides;if(p){f=plywood_1.AttributeInfo.override(f,plywood_1.AttributeInfo.fromJSs(p));if((e.options||{}).attributeOverrides){delete e.options["attributeOverrides"]}}var c=e.specialTimeDimension||e.specialTimeAttribute||e.realTimeAttribute||e.primaryTimeAttribute;if(!c&&e.timeAttribute&&e.timeAttribute!=="__time"){c=e.timeAttribute;if(!a)a={};a.druidTimeAttributeName=c}if(!c){var d=o[0];if(d&&d.name==="__time"&&d.type!=="TIME"){o[0]=d.changeType("TIME")}c=t.getPossibleTimeDimension(o)}if(i&&t.INTROSPECTION_VALUES.indexOf(i)===-1){throw new Error("invalid introspection value "+i+", must be one of "+t.INTROSPECTION_VALUES.join(", "))}var _=e.refreshRule?refresh_rule_1.RefreshRule.fromJS(e.refreshRule):null;var y=e.subsetFormula||e.subsetFilter;var h=e.longForm;if(h){l=l.concat(measuresFromLongForm(h));if(h.addSubsetFilter){var v=y?plywood_1.Expression.fromJSLoose(e.subsetFormula):plywood_1.Expression.TRUE;y=JSON.stringify(v.and(filterFromLongForm(h)).simplify())}}var g={dimensions:o,measure:e.defaultSortMeasure||(l&&l.length?l[0].name:null)};var b={name:e.name,title:e.title,description:e.description,clusterName:r,source:e.source,group:e.group,subsetFormula:y,rollup:e.rollup,options:a,introspection:i,attributes:f,dimensions:o,measures:l,specialTimeDimension:c,defaultTimezone:e.defaultTimezone?chronoshift_1.Timezone.fromJS(e.defaultTimezone):null,defaultFilter:e.defaultFilter?filter_1.Filter.fromJS(e.defaultFilter):null,defaultSplits:n?splits_1.Splits.fromJS(n,g):null,defaultDuration:e.defaultDuration?chronoshift_1.Duration.fromJS(e.defaultDuration):null,defaultSortMeasure:e.defaultSortMeasure,defaultSelectedMeasures:e.defaultSelectedMeasures,defaultPinnedDimensions:e.defaultPinnedDimensions,refreshRule:_};return new t(b)};t.prototype._validateDefaults=function(){var e=this,t=e.measures,r=e.defaultSortMeasure;if(r){if(!immutable_class_1.NamedArray.findByName(t,r)){throw new Error("can not find defaultSortMeasure '"+r+"' in data cube '"+this.name+"'")}}};t.prototype.toExternal=function(e,t){if(this.clusterName==="native")throw new Error("there is no external on a native data cube");var r=this.options;if(!r)r={};var i=this.getEffectiveAttributesAndDerivedAttributes();var n={engine:e.type,suppress:true,source:this.source,version:e.version,customAggregations:r.customAggregations,customTransforms:r.customTransforms,attributes:i.attributes,derivedAttributes:i.derivedAttributes,filter:this.subsetExpression};if(t){n.requester=t}if(e.type==="druid"){n.rollup=this.rollup;n.introspectionStrategy=e.getIntrospectionStrategy();n.allowSelectQueries=true;n.allowEternity=!this.getSpecialTimeDimension();if(r.druidTimeAttributeName){n.timeAttribute=r.druidTimeAttributeName}var a=r.druidContext||{};a["timeout"]=e.getTimeout();if(r.priority)a["priority"]=r.priority;n.context=a}return plywood_1.External.fromValue(n)};t.prototype.getMainTypeContext=function(){var e=this.dimensions;if(!e)return null;var t={};for(var r=0,i=e;r<i.length;r++){var n=i[r];t[n.name]={type:n.type}}return{type:"DATASET",datasetType:t}};t.prototype.getMeasureTypeContext=function(){return{type:"DATASET",datasetType:{main:this.getMainTypeContext()}}};t.prototype.validateFilterFormula=function(e){var t=plywood_1.Expression.parse(e);if(t instanceof plywood_1.LiteralExpression){if(t.type==="BOOLEAN")return true;throw new Error("must be a boolean")}return true};t.prototype.validateMeasureFormula=function(e){var t=plywood_1.Expression.parse(e);if(t.getFreeReferences().indexOf("main")===-1){throw new Error("Measure formula must contain a $main reference")}return true};t.prototype.getClusterType=function(e){var t=this.clusterName;if(t==="native")return"native";var r=immutable_class_1.NamedArray.findByName(e,t);if(!r)throw new Error("can not find cluster '"+t+"'");return r.type};t.prototype.getMaxTimeQuery=function(){var e=this.getRefreshRule();if(!e.isQuery())return null;var t=this.getSpecialTimeDimension();if(!t)return null;return plywood_1.ply().apply(MAX_TIME,plywood_1.$("main").max(t.expression))};t.prototype.getMaxTime=function(e){var t=this.name;var r=this.getRefreshRule();if(r.isRealtime()){return e.now()}else if(r.isFixed()){return r.time}else{return e.getTime(t)}};t.prototype.updatedText=function(e,t){var r=this.getRefreshRule();if(r.isRealtime()){return"Updated ~1 second ago"}else if(r.isFixed()){return"Fixed to "+beltful_1.DateUtils.getWallTimeString(r.time,t,true)}else{var i=this.getMaxTime(e);if(i){return"Updated "+formatTimeDiff(e.now().valueOf()-i.valueOf().valueOf())+" ago"}else{return null}}};t.prototype.getSuggestedDimensions=function(e){return this.filterDimensions(t.suggestDimensions(e))};t.prototype.getSpecialTimeDimension=function(){var e=this.specialTimeDimension;if(e===t.NO_SPECIAL_TIME_DIMENSION)return null;var r=immutable_class_1.NamedArray.findByName(this.dimensions,e);if(!r||r.type!=="TIME")return null;return r};t.prototype.isSpecialTimeDimension=function(e){var t=this.getSpecialTimeDimension();if(!e||!t)return false;return t.name===e};t.prototype.isMandatoryFilter=function(e){return this.isSpecialTimeDimension(e)};t.prototype.getMeasures=function(){if(this.measures.length)return this.measures;return[measure_1.Measure.SIMPLE_COUNT]};t.prototype.getMeasure=function(e){return measure_1.Measure.getMeasure(this.getMeasures(),e)};t.prototype.getMeasureByExpression=function(e){return immutable_class_1.SimpleArray.find(this.getMeasures(),function(t){return t.expression.equals(e)})};t.prototype.getDimensionForDimension=function(e){return this.dimensions.filter(function(t){return t.usesAttribute(e)})};t.prototype.getMeasuresForDimension=function(e){return this.getMeasures().filter(function(t){return t.usesAttribute(e)})};t.prototype.getSuggestedMeasures=function(e){return this.filterMeasures(t.suggestMeasures(e))};t.prototype.filterMeasures=function(e){var t=this;return e.filter(function(e){if(immutable_class_1.NamedArray.findByName(t.measures,e.name))return false;if(immutable_class_1.NamedArray.findByName(t.dimensions,e.name))return false;var r=e.expression;if(immutable_class_1.SimpleArray.find(t.measures,function(e){return e.expression.equals(r)}))return false;return true})};t.prototype.removeDimension=function(e){var r=this.valueOf();r.dimensions=immutable_class_1.NamedArray.deleteByName(r.dimensions,e);r.measures=r.measures.filter(function(t){return!t.usesAttribute(e)});return new t(r)};t.prototype.removeMeasure=function(e){var t=this.measures.indexOf(e);if(t===-1){throw new Error("Unknown measure: "+e.toString())}var r=immutable_class_1.SimpleArray.deleteIndex(this.measures,t);return this.changeMeasures(r)};t.prototype.filterDimensions=function(e){var t=this,r=t.dimensions,i=t.measures;return e.filter(function(e){if(immutable_class_1.NamedArray.findByName(r,e.name))return false;if(immutable_class_1.NamedArray.findByName(i,e.name))return false;return true})};t.prototype.getEffectiveAttributes=function(){return this.getEffectiveAttributesAndDerivedAttributes().attributes};t.prototype.getEffectiveAttributesAndDerivedAttributes=function(){var e=this.attributes.slice();var t={};var r={};e.forEach(function(e){return t[e.name]=true});function i(r){if(t[r.name])return;e.push(r);t[r.name]=true}this.dimensions.forEach(function(e){e.expression.forEach(function(e){if(e instanceof plywood_1.RefExpression){i(plywood_1.AttributeInfo.fromJS({name:e.name,type:e.type||"NULL"}))}})});this.measures.forEach(function(e){e.expression.forEach(function(e){if(e instanceof plywood_1.RefExpression){var t=e.name;if(t!=="main"){i(plywood_1.AttributeInfo.fromJS({name:t,type:e.type||"NULL"}))}}})});this.subsetExpression.forEach(function(t){if(t instanceof plywood_1.RefExpression){var r=t.name;if(!immutable_class_1.NamedArray.findByName(e,r)){i(plywood_1.AttributeInfo.fromJS({name:r,type:t.type||"NULL"}))}}});return{attributes:e,derivedAttributes:r}};t.prototype.changeDimension=function(e){return this.changeDimensions(immutable_class_1.NamedArray.overrideByName(this.dimensions,e))};t.prototype.fillAllFromAttributes=function(e){var t=e.filter(function(e){return INTERESTING_NATIVE_TYPE[e.nativeType]});return this.appendAttributes(t).appendDimensions(this.getSuggestedDimensions(e)).appendMeasures(this.getSuggestedMeasures(e)).adoptSpecialTimeDimensionIfPossible()};t.prototype.getIntrospection=function(){return this.introspection||t.DEFAULT_INTROSPECTION};t.prototype.addMandatoryFiltersIfNeeded=function(e){var t=this.getSpecialTimeDimension();if(t&&!e.filteredOn(t.name)){e=e.setDynamic(t.name,plywood_1.$(filter_clause_1.FilterClause.MAX_TIME_REF_NAME).timeRange(this.getDefaultDuration(),-1))}return e};t.prototype.getDefaultSortMeasure=function(){if(this.defaultSortMeasure){return this.defaultSortMeasure}return this.getMeasures()[0].name};t.prototype.getDefaultSelectedMeasures=function(){var e=this.defaultSelectedMeasures;return e.length?e:this.measures.slice(0,4).map(function(e){return e.name})};t.prototype.makeDuplicate=function(e){return this.changeName(e).changeTitle(this.title+" (copy)")};t.prototype.adoptSpecialTimeDimensionIfPossible=function(){var e=this.getSpecialTimeDimension();if(e)return this;return this.changeSpecialTimeDimension(t.getPossibleTimeDimension(this.dimensions))};t.prototype.appendAttributes=function(e){return this.changeAttributes(plywood_1.AttributeInfo.override(this.attributes,e))};t.prototype.appendMeasures=function(e){return this.changeMeasures(this.measures.concat(e))};t.prototype.appendDimensions=function(e){return this.changeDimensions(this.dimensions.concat(e))};t.prototype.sameGroup=function(e){return Boolean(this.group&&this.group===e.group)};t.prototype.guessTitle=function(){if(!this.source)return this.title;var e=this.source.split(/[\/\\]/);var t=e[e.length-1];return beltful_1.StringUtils.makeTitle(t)};t.prototype.guessName=function(){if(!this.source)return this.name;var e=this.source.split(/[\/\\]/);var t=e[e.length-1];return beltful_1.StringUtils.makeUrlSafeName(t)};t.prototype.getLatitudeLongitudeDimensions=function(){var e=this.dimensions;var r=immutable_class_1.NamedArray.findByName(e,t.LATITUDE_NAME);var i=immutable_class_1.NamedArray.findByName(e,t.LONGITUDE_NAME);return r&&i?{latitude:r,longitude:i}:null};t.prototype.straightenDimensionName=function(e){var t=this.dimensions;e=e.changeName(beltful_1.StringUtils.generateUniqueName(e.guessName(),function(e){return!immutable_class_1.NamedArray.findByName(t,e)},{suffixIfAlreadyUnique:false,separator:"-",startAt:1}));if(e.title==="New dimension")e=e.changeTitle(e.guessTitle());return e};t.prototype.straightenMeasureName=function(e){var t=this;e=e.changeName(beltful_1.StringUtils.generateUniqueName(e.guessName(),function(e){return!t.getMeasure(e)},{suffixIfAlreadyUnique:false,separator:"-",startAt:1}));if(e.title==="New measure")e=e.changeTitle(e.guessTitle());return e};return t}(immutable_class_1.BaseImmutable);DataCube.DEFAULT_INTROSPECTION="autofill-all";DataCube.INTROSPECTION_VALUES=["none","no-autofill","autofill-dimensions-only","autofill-measures-only","autofill-all"];DataCube.DEFAULT_DEFAULT_TIMEZONE=chronoshift_1.Timezone.UTC;DataCube.DEFAULT_DEFAULT_FILTER=filter_1.Filter.EMPTY;DataCube.DEFAULT_DEFAULT_SPLITS=splits_1.Splits.EMPTY;DataCube.DEFAULT_DEFAULT_DURATION=chronoshift_1.Duration.fromJS("P1D");DataCube.NO_SPECIAL_TIME_DIMENSION="!NONE";DataCube.LATITUDE_NAME="lat";DataCube.LONGITUDE_NAME="lon";DataCube.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"description",defaultValue:""},{name:"clusterName",defaultValue:null},{name:"source",defaultValue:null},{name:"group",defaultValue:null},{name:"subsetFormula",defaultValue:null},{name:"rollup",defaultValue:false},{name:"complete",defaultValue:false},{name:"options",defaultValue:{},equal:function(e,t){return JSON.stringify(e)===JSON.stringify(t)}},{name:"introspection",defaultValue:DataCube.DEFAULT_INTROSPECTION},{name:"attributes",immutableClassArray:plywood_1.AttributeInfo,type:immutable_class_1.PropertyType.ARRAY},{name:"dimensions",immutableClassArray:dimension_1.Dimension,type:immutable_class_1.PropertyType.ARRAY},{name:"measures",immutableClassArray:measure_1.Measure,type:immutable_class_1.PropertyType.ARRAY},{name:"specialTimeDimension"},{name:"defaultTimezone",immutableClass:chronoshift_1.Timezone,defaultValue:DataCube.DEFAULT_DEFAULT_TIMEZONE},{name:"defaultFilter",immutableClass:filter_1.Filter,defaultValue:DataCube.DEFAULT_DEFAULT_FILTER},{name:"defaultSplits",immutableClass:splits_1.Splits,defaultValue:DataCube.DEFAULT_DEFAULT_SPLITS},{name:"defaultDuration",immutableClass:chronoshift_1.Duration,defaultValue:DataCube.DEFAULT_DEFAULT_DURATION},{name:"defaultSortMeasure",defaultValue:null},{name:"defaultSelectedMeasures",type:immutable_class_1.PropertyType.ARRAY},{name:"defaultPinnedDimensions",type:immutable_class_1.PropertyType.ARRAY},{name:"refreshRule",immutableClass:refresh_rule_1.RefreshRule,defaultValue:refresh_rule_1.RefreshRule.query()}];exports.DataCube=DataCube;immutable_class_1.BaseImmutable.finalize(DataCube);