"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var plywood_1=require("plywood");var colors_1=require("../colors/colors");var split_combine_1=require("../split-combine/split-combine");var splits_1=require("../splits/splits");var base_manifest_1=require("./base-manifest");var LineChartManifest=function(e){tslib_1.__extends(t,e);function t(){var t=e!==null&&e.apply(this,arguments)||this;t.name="line-chart";t.title="Line Chart";return t}t.prototype.ensureSplitOrder=function(e,t,i,n){if(e.toArray().every(function(e){return e.isBucketed()})){var r=e.splitCombines.filter(function(e){return e.getDimension(n).getKind()==="time"});var s=null;if(r.length>=1)s=r[0];if(s&&t!==s){return{primarySplit:s,colorSplit:t}}}return{primarySplit:t,colorSplit:i}};t.prototype.summonBucketableSplit=function(e,t,i){var n=e.isSortOnSelfAscending();var r=e.limitAction,s=e.bucketAction;if(n&&!r&&s)return e;var l=e.dimension;if(!s)e=e.addBucketGivenFilter(i,t);if(!n)e=e.changeSortAction(plywood_1.Expression._.sort(plywood_1.$(l),plywood_1.SortExpression.ASCENDING));if(r)e=e.changeLimitAction(null);return e};t.prototype.summon=function(e,t,i,n,r){var s=this;var l=t.splitCombines.find(function(t){return t.isBucketable(e)});var o=function(e){return{splits:new splits_1.Splits(e)}};var a=function(t){return s.summonBucketableSplit(t,e,i)};if(t.length()===1&&l){return o([a(l)])}else if(t.isBucketedFollowedByUnbucketed()){var u=t.get(0);var f=t.get(1);var c=this.ensureSplitOrder(t,u,f,e),m=c.primarySplit,p=c.colorSplit;return o([p,a(m)])}else if(t.length()===2&&l){var p=t.splitCombines.filter(function(e){return!e.equals(l)})[0];if(p.isBucketable(e))return null;return o([p,a(l)])}return null};t.prototype.canHandleSplitDimensions=function(e,t,i,n){var r=e.filter(function(e){return e.isBucketable()});var s=function(e){return split_combine_1.SplitCombine.fromDimensionAndFilterAndMeasure(e,i,n)};if(!t.some(function(e){return e.isBucketable()})){return base_manifest_1.Resolve.rejectDimensions("The Line chart requires at least one bucketed split",r.map(function(e){return base_manifest_1.SplitSuggestion.fromTitleAndSplit("Add a split on "+e.title,s(e))}))}else if(!t.length){return base_manifest_1.Resolve.rejectDimensions("The Line Chart requires at least one bucketed split",r.map(function(e){return base_manifest_1.SplitSuggestion.fromTitleAndSplit("Add a split on "+e.title,s(e))}))}else if(t.length>2&&r.length){return base_manifest_1.Resolve.rejectDimensions("Too many splits on the line chart",[base_manifest_1.SplitSuggestion.fromTitleAndSplit("Remove all but the first bucketed split",s(t[0]))])}else{return base_manifest_1.Resolve.proceedWithDimensions()}};t.prototype.getSuitability=function(e,t,i,n){var r=false;var s=t.splitCombines.some(function(t){return t.getDimension(e).getKind()==="time"})?9:5;var l=null;if(t.length()===1){l=t.first();if(i)r=true}else{var o=t.first();l=t.get(1);if(!i||i.dimension!==o.dimension||!o.limitAction){r=true}}if(n)s=10;if(l.limitAction){var a=base_manifest_1.Resolve.rejectCombines("The line chart cannot handle a limit",["table","bar-chart"]);return new base_manifest_1.Suitability(0,a)}if(!l.isSortOnSelfAscending()){var a=base_manifest_1.Resolve.rejectCombines("The line chart cannot handle this sort",["table"]);return new base_manifest_1.Suitability(0,a)}if(!l.isBucketed()){var a=base_manifest_1.Resolve.rejectCombines("The line chart must have a bucketed second split",["table"]);return new base_manifest_1.Suitability(0,a)}return new base_manifest_1.Suitability(r?s-1:s)};t.prototype.getEffectiveSplits=function(e){if(e.length()===2){var t=e.first();if(!t.limitAction){e=e.replace(t,t.changeLimit(5))}}return e};t.prototype.getEffectiveColors=function(e,t){if(e.length()===0||e.length()===1){t=null}else{var i=e.first();var n=i.dimension;if(!t||t.dimension!==n){t=colors_1.Colors.fromLimit(n,5)}}return t};return t}(base_manifest_1.Manifest);exports.LineChartManifest=LineChartManifest;exports.LINE_CHART_MANIFEST=new LineChartManifest;