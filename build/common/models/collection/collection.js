"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var immutable_class_1=require("immutable-class");var collection_tile_1=require("../collection-tile/collection-tile");var filter_1=require("../filter/filter");var Collection=function(e){tslib_1.__extends(t,e);function t(i){var l=e.call(this,i)||this;if(l.layout==="dashboard"){var n=l.size||t.DEFAULT_SIZE;var a=t.fitTiles(l.tiles,n,t.DEFAULT_TILE_SIZE),r=a.newTiles,o=a.newSize;l.size=o;l.tiles=r}if(!l.tiles)l.tiles=[];return l}t.isCollection=function(e){return e instanceof t};t.fitTiles=function(e,t,i){var l=e.map(function(e){return e.position}).filter(Boolean);var n=t.width-i.width;var a=0;function r(){return i.changeXY(a%n,Math.floor(a/n))}function o(){var e=r();while(l.some(function(t){return t.overlapsWith(e)})){a++;e=r()}l.push(e);return e}return{newTiles:e.map(function(e){return e.position?e:e.changePosition(o())}),newSize:t.changeHeight(Math.max(t.height,Math.floor(a/n)+i.height))}};t.fromJS=function(e,i){if(!i)throw new Error("Collection must have context");if(!e.name)throw new Error("Collection must have a name");var l=e.tiles||e.items||e.linkItems||[];return new t({title:e.title,name:e.name,description:e.description,layout:e.layout,size:e.size?beltful_1.Stage.fromJS(e.size):null,shareTimezone:e.shareTimezone,shareFilter:e.shareFilter,tiles:l.map(function(e){return collection_tile_1.CollectionTile.fromJS(e,i)})})};t.prototype.getDefaultTile=function(){return this.tiles[0]};t.prototype.isNameAvailable=function(e){return!this.getCollectionTile(e)};t.prototype.dependsOnDataCube=function(e){return this.tiles.some(function(t){return t.dataCube.name===e})};t.prototype.getCommonEssence=function(){var e=this,t=e.shareFilter,i=e.tiles;if(!t)return null;if(!i.length)return null;return i[0].essence.changeFilter(filter_1.Filter.EMPTY)};t.prototype.makeDuplicate=function(e){return this.changeName(e).changeTitle(this.title+" (copy)")};t.prototype.getMaxOccupiedRow=function(){var e=this,t=e.tiles,i=e.layout;if(i!=="dashboard")return null;return t.map(function(e){return e.position.y+e.position.height}).reduce(function(e,t){return Math.max(e,t)},0)};t.prototype.getCollectionTile=function(e){return immutable_class_1.NamedArray.findByName(this.tiles,e)};t.prototype.changeLayout=function(e){if(this.layout===e)return this;var i=this.valueOf();i.layout=e;return new t(i)};t.prototype.addOrUpdateTile=function(e){return this.changeTiles(immutable_class_1.NamedArray.overrideByName(this.tiles,e))};t.prototype.deleteTile=function(e){return this.changeTiles(immutable_class_1.NamedArray.deleteByName(this.tiles,e))};t.prototype.constrainTilesToDataCubes=function(e){return this.changeTiles(this.tiles.filter(function(t){return immutable_class_1.NamedArray.containsByName(e,t.dataCube.name)}))};return t}(immutable_class_1.BaseImmutable);Collection.DEFAULT_SIZE=beltful_1.Stage.fromSize(24,12);Collection.DEFAULT_TILE_SIZE=beltful_1.Stage.fromSize(8,5);Collection.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"description",defaultValue:null},{name:"layout",defaultValue:"album"},{name:"size",immutableClass:beltful_1.Stage,defaultValue:null},{name:"verticalUnits",defaultValue:null},{name:"shareTimezone",defaultValue:false},{name:"shareFilter",defaultValue:false},{name:"tiles",immutableClassArray:collection_tile_1.CollectionTile}];exports.Collection=Collection;immutable_class_1.BaseImmutable.finalize(Collection);