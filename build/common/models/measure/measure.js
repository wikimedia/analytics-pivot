"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var immutable_class_1=require("immutable-class");var numeral=require("numeral");var plywood_1=require("plywood");function formatFnFactory(e){return function(t){if(isNaN(t)||!isFinite(t))return"-";return numeral(t).format(e)}}var Measure=function(e){tslib_1.__extends(t,e);function t(t){var n=e.call(this,t)||this;n.title=n.title||beltful_1.StringUtils.makeTitle(n.name);n.expression=plywood_1.Expression.parse(n.formula);n.formatFn=formatFnFactory(n.getFormat());n.companionExpression=n.companion?plywood_1.Expression.parse(n.companion):null;return n}t.isMeasure=function(e){return e instanceof t};t.getMeasure=function(e,t){if(!t)return null;return immutable_class_1.NamedArray.findByNameCI(e,t)};t.measuresFromAttribute=function(e){var n=e.name,a=e.type,r=e.nativeType,i=e.maker;var l=plywood_1.$("main");var u=plywood_1.$(n);if(n==="count"||i&&i.op==="count"){return[new t({name:beltful_1.StringUtils.makeUrlSafeName(n),title:beltful_1.StringUtils.makeTitle(n),formula:l.sum(u).toString()})]}else if(r==="hyperUnique"||r==="thetaSketch"){return[new t({name:beltful_1.StringUtils.makeUrlSafeName("cd_"+n),title:beltful_1.StringUtils.makeTitle(n)+(r==="thetaSketch"?" Unique":""),formula:l.countDistinct(u).toString()})]}else if(r==="approximateHistogram"){return[new t({name:beltful_1.StringUtils.makeUrlSafeName(n+"_p98"),title:beltful_1.StringUtils.makeTitle(n)+" 98th %tile",formula:l.quantile(u,.98).toString()})]}else if(a==="NUMBER"){var o=l.sum(u);var s="sum";if(i){s=i.op;switch(i.op){case"min":o=l.min(u);break;case"max":o=l.max(u);break}}return[new t({name:beltful_1.StringUtils.makeUrlSafeName(s+"_"+n),title:s==="sum"?beltful_1.StringUtils.makeTitle(n):null,formula:o.toString()})]}else{return[]}};t.fromJS=function(e){if(!e.formula){var n=e.expression;e.formula=typeof n==="string"?n:plywood_1.$("main").sum(plywood_1.$(e.name)).toString()}return new t(immutable_class_1.BaseImmutable.jsToValue(t.PROPERTIES,e))};t.prototype.toApplyAction=function(){var e=this,t=e.name,n=e.expression,a=e.companionExpression;var r=plywood_1.Expression._.apply(t,n);if(a){r=r.apply(this.getCompanionName(),a)}return r};t.prototype.formatDatum=function(e){return e?this.formatFn(e[this.name]):null};t.prototype.formatCompanion=function(e){var t=this.getCompanionName();return e&&t?this.formatFn(e[t]):null};t.prototype.formatDatumWithCompanion=function(e){var t=this.formatDatum(e);if(!t)return null;var n=this.formatCompanion(e);return t+(n?" ("+n+")":"")};t.prototype.getCompanionName=function(){return this.companion?this.name+"_c":null};t.prototype.getTitleWithUnits=function(){if(this.units){return this.title+" ("+this.units+")"}else{return this.title}};t.prototype.usesAttribute=function(e){return this.expression.some(function(t,n,a,r){if(r>0&&t instanceof plywood_1.RefExpression){return t.name===e}else{return null}})};t.prototype.guessName=function(){return beltful_1.StringUtils.makeUrlSafeName(this.formula)};t.prototype.guessTitle=function(){return beltful_1.StringUtils.makeTitle(this.name)};return t}(immutable_class_1.BaseImmutable);Measure.DEFAULT_FORMAT="0,0.0 a";Measure.INTEGER_FORMAT="0,0 a";Measure.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"group",defaultValue:null},{name:"units",defaultValue:null},{name:"formula"},{name:"format",defaultValue:Measure.DEFAULT_FORMAT},{name:"companion",defaultValue:null}];exports.Measure=Measure;immutable_class_1.BaseImmutable.finalize(Measure);Measure.SIMPLE_COUNT=new Measure({name:"default_count",title:"Default Count",formula:"$main.count()"});