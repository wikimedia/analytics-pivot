"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var lz_string_1=require("lz-string");var plywood_1=require("plywood");var colors_1=require("../colors/colors");var dimension_1=require("../dimension/dimension");var filter_clause_1=require("../filter-clause/filter-clause");var filter_1=require("../filter/filter");var highlight_1=require("../highlight/highlight");var splits_1=require("../splits/splits");var HASH_VERSION=2;function constrainDimensions(e,t){return e.filter(function(e){return Boolean(immutable_class_1.NamedArray.findByName(t,e))})}function constrainMeasures(e,t){return e.filter(function(e){return Boolean(t.getMeasure(e))})}function addToSetInOrder(e,t,i){return e.filter(function(e){return t.indexOf(e)!==-1||e===i})}var VisStrategy;(function(e){e[e["FairGame"]=0]="FairGame";e[e["UnfairGame"]=1]="UnfairGame";e[e["KeepAlways"]=2]="KeepAlways"})(VisStrategy=exports.VisStrategy||(exports.VisStrategy={}));var TO_MEASURE_MODE={false:"single",true:"multi",single:"single",multi:"multi"};function evaluationLog(e){}var check;var Essence=function(){function e(t){var i=t.visualizations,s=t.dataCube,n=t.defaultMeasureModes,r=t.visualization,a=t.timezone,o=t.filter,u=t.splits,l=t.measureMode,f=t.singleMeasure,h=t.selectedMeasures,c=t.pinnedDimensions,m=t.colors,p=t.pinnedSort,g=t.highlight,d=t.customDimensions;if(!s)throw new Error("Essence must have a dataCube");if(!n)n=e.DEFAULT_DEFAULT_MEASURE_MODE;a=a||chronoshift_1.Timezone.UTC;if(!o){o=s.getDefaultFilter()}o=s.addMandatoryFiltersIfNeeded(o);function v(e){return l==="multi"?immutable_class_1.SimpleArray.contains(h,e):e===f}if(g&&g.measure&&!v(g.measure)){g=null}if(!d)d=[];var M=s.dimensions.concat(d);var S=null;if(i){var y=f||s.getDefaultSortMeasure();if(!r){r=e.getBestVisualization(i,M,u,o,y,m,null).visualization}var D=u.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(M,e.dimension)});S=r.canHandleSplitDimensions(M,D,o,y);if(S.proceedWithDimensions()){var _=r.getSuitability(M,u,m,t.visualization===r);if(_.cantHandleCombine)S=_.cantHandleCombine}}l=TO_MEASURE_MODE[String(l)]||n[r.name]||"single";this.visualizations=i;this.dataCube=s;this.defaultMeasureModes=n;this.visualization=r;this.timezone=a;this.filter=o;this.splits=u;this.measureMode=l;this.singleMeasure=f;this.selectedMeasures=h;this.pinnedDimensions=c;this.colors=m;this.pinnedSort=p;this.highlight=g;this.customDimensions=d;this.visResolve=S}e.isEssence=function(t){return t instanceof e};e.getBestVisualization=function(e,t,i,s,n,r,a){var o=a?a.name:null;var u=i.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(t,e.dimension)});var l=e.filter(function(e){return e.canHandleSplitDimensions(t,u,s,n).proceedWithDimensions()});evaluationLog("Start evaluation");return l.map(function(e){var s=e.getSuitability(t,i,r,e.name===o);evaluationLog("> "+e.name+": "+s.score);return{suitability:s,visualization:e}}).sort(function(e,t){return t.suitability.score-e.suitability.score})[0]};e.fromHash=function(t,i){var s=t.split("/");if(s.length<3)return null;var n=s.shift();var r=parseInt(s.shift(),10);if(r>HASH_VERSION)return null;var a=null;try{a=JSON.parse("["+lz_string_1.decompressFromBase64(s.join("/"))+"]")}catch(e){return null}if(!Array.isArray(a))return null;if(r===1){a.splice(3,0,false,null)}var o=a.length;if(!(8<=o&&o<=11))return null;var u;try{u=e.fromJS({visualization:n,timezone:a[0],filter:a[1],splits:a[2],measureMode:a[3],singleMeasure:a[4],selectedMeasures:a[5],pinnedDimensions:a[6],pinnedSort:a[7],colors:a[8]||null,highlight:a[9]||null,customDimensions:a[10]||null},i)}catch(e){return null}return u};e.fromDataCube=function(t,i){var s=t.getDefaultSplits();var n=t.getDefaultFilter();var r=s.initializeGivenFilter(n,t.dimensions,t.getDefaultSortMeasure());return new e({dataCube:i.dataCube,visualizations:i.visualizations,defaultMeasureModes:i.defaultMeasureModes,visualization:null,timezone:t.getDefaultTimezone(),filter:t.getDefaultFilter(),splits:r,singleMeasure:t.getDefaultSortMeasure(),selectedMeasures:t.getDefaultSelectedMeasures(),pinnedDimensions:t.getDefaultPinnedDimensions(),colors:null,pinnedSort:t.getDefaultSortMeasure(),highlight:null,customDimensions:null})};e.fromJS=function(t,i){if(!i)throw new Error("Essence must have context");var s=i.dataCube,n=i.visualizations,r=i.defaultMeasureModes;var a=t.visualization;if(a==="time-series")a="line-chart";var o=immutable_class_1.NamedArray.findByName(n,a);var u=t.timezone?chronoshift_1.Timezone.fromJS(t.timezone):null;var l=[];var f=t.customDimensions;if(Array.isArray(f)){l=f.map(function(e){return dimension_1.Dimension.fromJS(e)})}var h=s.dimensions.concat(l);var c=t.filter?filter_1.Filter.fromJS(t.filter).constrainToDimensions(h):null;var m={dimensions:h,measure:t.singleMeasure||s.getDefaultSortMeasure()};var p=splits_1.Splits.fromJS(t.splits||[],m).constrainToDimensionsAndMeasures(h,s.getMeasures());var g=s.getDefaultSortMeasure();var d=TO_MEASURE_MODE[t.measureMode||t.multiMeasureMode];var v=s.getMeasure(t.singleMeasure)?t.singleMeasure:g;var M=constrainMeasures(t.selectedMeasures||[],s);var S=constrainDimensions(t.pinnedDimensions||[],h);var y=t.colors?colors_1.Colors.fromJS(t.colors):null;var D=s.getMeasure(t.pinnedSort)?t.pinnedSort:g;var _=null;var b=t.highlight;if(b){_=highlight_1.Highlight.fromJS(b).constrainToDimensions(h)}return new e({dataCube:s,visualizations:n,defaultMeasureModes:r,visualization:o,timezone:u,filter:c,splits:p,measureMode:d,singleMeasure:v,selectedMeasures:M,pinnedDimensions:S,colors:y,pinnedSort:D,highlight:_,customDimensions:l})};e.prototype.valueOf=function(){return{dataCube:this.dataCube,visualizations:this.visualizations,defaultMeasureModes:this.defaultMeasureModes,visualization:this.visualization,timezone:this.timezone,filter:this.filter,splits:this.splits,measureMode:this.measureMode,singleMeasure:this.singleMeasure,selectedMeasures:this.selectedMeasures,pinnedDimensions:this.pinnedDimensions,colors:this.colors,pinnedSort:this.pinnedSort,highlight:this.highlight,customDimensions:this.customDimensions}};e.prototype.toJS=function(){var e={visualization:this.visualization.name,timezone:this.timezone.toJS(),filter:this.filter.toJS(),splits:this.splits.toJS(),singleMeasure:this.singleMeasure,selectedMeasures:this.selectedMeasures,pinnedDimensions:this.pinnedDimensions};if(this.measureMode)e.measureMode=this.measureMode;if(this.colors)e.colors=this.colors.toJS();var t=this.dataCube.getDefaultSortMeasure();if(this.pinnedSort!==t)e.pinnedSort=this.pinnedSort;if(this.highlight)e.highlight=this.highlight.toJS();if(this.customDimensions.length)e.customDimensions=this.customDimensions.map(function(e){return e.toJS()});return e};e.prototype.toJSON=function(){return this.toJS()};e.prototype.toString=function(){return"[Essence]"};e.prototype.equals=function(t){return e.isEssence(t)&&this.dataCube.name===t.dataCube.name&&this.visualization.name===t.visualization.name&&this.timezone.equals(t.timezone)&&this.filter.equals(t.filter)&&this.splits.equals(t.splits)&&this.measureMode===t.measureMode&&this.singleMeasure===t.singleMeasure&&immutable_class_1.generalArraysEqual(this.selectedMeasures,t.selectedMeasures)&&immutable_class_1.generalArraysEqual(this.pinnedDimensions,t.pinnedDimensions)&&immutable_class_1.immutableEqual(this.colors,t.colors)&&this.pinnedSort===t.pinnedSort&&immutable_class_1.immutableEqual(this.highlight,t.highlight)&&immutable_class_1.immutableArraysEqual(this.customDimensions,t.customDimensions)};e.prototype.toHash=function(){var e=this.toJS();var t=[e.timezone,e.filter,e.splits,e.measureMode,e.singleMeasure,e.selectedMeasures,e.pinnedDimensions,e.pinnedSort];if(e.colors){t[8]=e.colors}if(e.highlight){t[9]=e.highlight}if(e.customDimensions){t[10]=e.customDimensions}var i=[];for(var s=0;s<t.length;s++){i.push(JSON.stringify(t[s]||null))}return[e.visualization,HASH_VERSION,lz_string_1.compressToBase64(i.join(","))].join("/")};e.prototype.getURL=function(){return this.dataCube.name+"/"+this.toHash()};e.prototype.getTitle=function(){var e=this.getDimensions();var t=this.getEffectiveMeasures();var i=this.splits.toArray().map(function(t){return t.getDimension(e).title}).join(", ")||"Total";if(t.length===1){i=i+" by "+t[0].title}return i};e.prototype.getDimensions=function(){return this.dataCube.dimensions.concat(this.customDimensions)};e.prototype.getDimension=function(e){return dimension_1.Dimension.getDimension(this.getDimensions(),e)};e.prototype.evaluateSelection=function(e,t){var i=this,s=i.timezone,n=i.dataCube;return filter_clause_1.FilterClause.evaluate(e,t.now(),n.getMaxTime(t),s)};e.prototype.evaluateClause=function(e,t){var i=this,s=i.timezone,n=i.dataCube;return e.evaluate(t.now(),n.getMaxTime(t),s)};e.prototype.getEffectiveFilter=function(e,t,i){if(t===void 0){t=null}if(i===void 0){i=null}var s=this,n=s.dataCube,r=s.filter,a=s.highlight,o=s.timezone;if(a&&t!==a.owner)r=r.applyDelta(a.delta);if(i)r=r.remove(i.name);return r.getSpecificFilter(e.now(),n.getMaxTime(e),o)};e.prototype.getRealTimeSelection=function(){var e=this.dataCube.getSpecialTimeDimension();if(!e)return null;return this.filter.getSelection(e.name)};e.prototype.getMeasureMode=function(){return this.measureMode||"single"};e.prototype.getEffectiveMeasures=function(){var e;if(this.getMeasureMode()==="multi"){e=this.getMeasures()}else{e=[this.dataCube.getMeasure(this.singleMeasure)]}if(this.dataCube.title.match(/#test$/)){e=e.map(function(e){return e.changeCompanion(JSON.stringify(e.expression.multiply(1.2)))})}else if(this.dataCube.title.match(/@test$/)){e=e.map(function(e){return e.changeCompanion(JSON.stringify(e.expression.substitute(function(e){if(e instanceof plywood_1.RefExpression&&e.name==="main"){return plywood_1.$("cmp")}else{return null}})))})}return e};e.prototype.getFirstSelectedMeasure=function(){var e=this.selectedMeasures;return e?e[0]:null};e.prototype.getMeasures=function(){var e=this.dataCube;return this.selectedMeasures.map(function(t){return e.getMeasure(t)})};e.prototype.getSortMeasure=function(){return(this.getMeasureMode()==="multi"?this.getFirstSelectedMeasure():this.singleMeasure)||this.dataCube.getDefaultSortMeasure()};e.prototype.getEffectiveSelectedMeasure=function(){if(this.getMeasureMode()==="multi"){return this.selectedMeasures}else{return[this.singleMeasure]}};e.prototype.differentDataCube=function(e){return this.dataCube!==e.dataCube};e.prototype.differentTimezone=function(e){return!this.timezone.equals(e.timezone)};e.prototype.differentTimezoneMatters=function(e){return this.splits.timezoneDependant()&&this.differentTimezone(e)};e.prototype.differentFilter=function(e){return!this.filter.equals(e.filter)};e.prototype.differentSplits=function(e){return!this.splits.equals(e.splits)};e.prototype.differentEffectiveSplits=function(e){return this.differentSplits(e)||this.differentTimezoneMatters(e)};e.prototype.differentColors=function(e){if(Boolean(this.colors)!==Boolean(e.colors))return true;if(!this.colors)return false;return!this.colors.equals(e.colors)};e.prototype.differentSelectedMeasures=function(e){return!immutable_class_1.generalArraysEqual(this.selectedMeasures,e.selectedMeasures)};e.prototype.differentEffectiveMeasures=function(e){return!immutable_class_1.generalArraysEqual(this.getEffectiveSelectedMeasure(),e.getEffectiveSelectedMeasure())};e.prototype.isSubset=function(e,t){return e.every(function(e){return t.indexOf(e)!==-1})};e.prototype.newSelectedMeasures=function(e){return!this.isSubset(this.selectedMeasures,e.selectedMeasures)};e.prototype.newEffectiveMeasures=function(e){return!this.isSubset(this.getEffectiveSelectedMeasure(),e.getEffectiveSelectedMeasure())};e.prototype.differentPinnedDimensions=function(e){return!immutable_class_1.generalArraysEqual(this.pinnedDimensions,e.pinnedDimensions)};e.prototype.differentPinnedSort=function(e){return this.pinnedSort!==e.pinnedSort};e.prototype.differentHighlight=function(e){if(Boolean(this.highlight)!==Boolean(e.highlight))return true;return Boolean(this.highlight&&!this.highlight.equals(e.highlight))};e.prototype.differentEffectiveFilter=function(e,t,i,s,n){if(s===void 0){s=null}if(n===void 0){n=null}var r=this.getEffectiveFilter(t,s,n);var a=e.getEffectiveFilter(i,s,n);return!r.equals(a)};e.prototype.highlightOn=function(e,t){var i=this.highlight;if(!i)return false;return i.owner===e&&(!t||i.measure===t)};e.prototype.highlightOnDifferentMeasure=function(e,t){var i=this.highlight;if(!i)return false;return i.owner===e&&t&&i.measure!==t};e.prototype.getSingleHighlightSet=function(){var e=this.highlight;if(!e)return null;return e.delta.getSingleClauseSet()};e.prototype.getApplyForSort=function(e){var t=e.expression.name;var i=this.dataCube.getMeasure(t);if(!i)return null;return i.toApplyAction()};e.prototype.updateDataCube=function(t){var i=this,s=i.dataCube,n=i.customDimensions;if(s.equals(t))return this;var r=s.getSpecialTimeDimension();var a=t.getSpecialTimeDimension();var o={};if(r&&a){o[r.name]=a.name}var u=t.dimensions.concat(n);var l=this.valueOf();l.dataCube=t;l.filter=l.filter.renameDimensions(o).constrainToDimensions(u);l.splits=l.splits.constrainToDimensionsAndMeasures(u,t.getMeasures());l.selectedMeasures=constrainMeasures(l.selectedMeasures,t);if(l.selectedMeasures.length===0){l.selectedMeasures=t.getDefaultSelectedMeasures()}l.pinnedDimensions=constrainDimensions(l.pinnedDimensions,u);if(l.colors&&!immutable_class_1.NamedArray.findByName(u,l.colors.dimension)){l.colors=null}if(!t.getMeasure(l.pinnedSort))l.pinnedSort=t.getDefaultSortMeasure();if(l.highlight){l.highlight=l.highlight.constrainToDimensions(u)}return new e(l)};e.prototype.updateDefaultMeasureModes=function(t){var i=this.valueOf();i.defaultMeasureModes=t;return new e(i)};e.prototype.changeFilter=function(t,i){if(i===void 0){i=false}var s=this.filter;var n=this.valueOf();n.filter=t;if(i){n.highlight=null}return new e(n).updateSplitsAfterFilterChange(s)};e.prototype.addToFilter=function(e,t){if(t===void 0){t=false}return this.changeFilter(this.filter.applyDelta(e),t)};e.prototype.changeTimezone=function(t){var i=this.timezone;if(i===t)return this;var s=this.valueOf();s.timezone=t;return new e(s)};e.prototype.convertToSpecificFilter=function(e){var t=this,i=t.dataCube,s=t.filter,n=t.timezone;if(!s.isDynamic())return this;return this.changeFilter(s.getSpecificFilter(e.now(),i.getMaxTime(e),n))};e.prototype.getEffectiveColors=function(){var e=this,t=e.visualization,i=e.splits,s=e.colors;if(!t)return null;return t.getEffectiveColors(i,s)};e.prototype.getEffectiveSplits=function(){var e=this,t=e.visualization,i=e.splits;if(!t)return null;return t.getEffectiveSplits(i)};e.prototype.getSplitForDimension=function(e){return this.splits.findSplitForDimension(e)};e.prototype.getEffectiveSplitForDimension=function(e){return this.getEffectiveSplits().findSplitForDimension(e)};e.prototype.getEffectiveColorSplit=function(){var e=this.getEffectiveColors();if(!e)return null;return this.getEffectiveSplitForDimension(e.dimension)};e.prototype.updateWithNewSplits=function(t,i){var s=this,n=s.visualizations,r=s.visualization,a=s.filter,o=s.colors;var u=this.getDimensions();var l=this.splits;if(this.visResolve.rejectedDimensions()){var f=t.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(u,e.dimension)});if(!r.canHandleSplitDimensions(u,f,a,this.getSortMeasure()).rejectedDimensions()){i=VisStrategy.KeepAlways}}if(l.sameOnDimensions(t)){i=VisStrategy.KeepAlways}if(i==null)i=l.getStrategyForSplitChange(t);if(i!==VisStrategy.KeepAlways){var h=e.getBestVisualization(n,u,t,a,this.getSortMeasure(),o,i===VisStrategy.FairGame?null:r);r=h.visualization}var c=this.valueOf();c.splits=t;if(c.visualization!==r){c.visualization=r;c.measureMode=this.defaultMeasureModes[r.name]||"single"}if(c.highlight){c.filter=c.filter.applyDelta(c.highlight.delta);c.highlight=null}return new e(c)};e.prototype.changeSplit=function(e,t){var i=this.splits;var s=i.splitCombines.find(function(t){return t.dimension===e.dimension});var n=s?i.replace(s,e):i.addSplit(e);return this.updateWithNewSplits(n,t)};e.prototype.initializeAndChangeSplits=function(e,t){var i=this.filter;var s=e.initializeGivenFilter(i,this.getDimensions(),this.getSortMeasure());return this.updateWithNewSplits(s,t)};e.prototype.addSplit=function(e,t){var i=this.splits;return this.initializeAndChangeSplits(i.addSplit(e),t)};e.prototype.removeSplit=function(e,t){var i=this.splits;return this.initializeAndChangeSplits(i.removeSplit(e))};e.prototype.updateSplitsAfterFilterChange=function(t){var i=this.valueOf();var s=i.splits,n=i.filter;var r=s.recalculateBucketsWithFilterChange(t,n,this.getDimensions());if(s===r)return this;i.splits=r;return new e(i)};e.prototype.changeColors=function(t){var i=this.valueOf();i.colors=t;return new e(i)};e.prototype.summonVisualization=function(t){if(t.name===this.visualization.name)return this;var i=this,s=i.splits,n=i.filter,r=i.singleMeasure,a=i.colors;var o=this.getDimensions();var u=t.canHandleSplitDimensions(o,s.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(o,e.dimension)}),n,this.getSortMeasure());var l=this.valueOf();if(u.proceedWithDimensions()){var f=t.summon(o,s,n,r,a);if(f){l.splits=f.splits;l.colors=f.colors}}l.visualization=t;l.measureMode=this.defaultMeasureModes[t.name]||"single";return new e(l)};e.prototype.pin=function(t){var i=this.valueOf();i.pinnedDimensions=immutable_class_1.SimpleArray.append(i.pinnedDimensions,t.name);return new e(i)};e.prototype.unpin=function(t){var i=this.valueOf();i.pinnedDimensions=immutable_class_1.SimpleArray.delete(i.pinnedDimensions,t.name);return new e(i)};e.prototype.getPinnedSortMeasure=function(){return this.dataCube.getMeasure(this.pinnedSort)};e.prototype.changePinnedSortMeasure=function(t){var i=this.valueOf();i.pinnedSort=t.name;return new e(i)};e.prototype.switchToMeasure=function(e){var t=this.changeSingleMeasure(e);return t.measureMode?t.toggleMultiMeasureMode():t};e.prototype.toggleMultiMeasureMode=function(){var t=this,i=t.dataCube,s=t.measureMode,n=t.selectedMeasures,r=t.singleMeasure;var a=this.valueOf();a.measureMode=s==="multi"?"single":"multi";if(s==="multi"){if(n.length&&n.indexOf(r)===-1){a.singleMeasure=n[0]}}else{a.selectedMeasures=addToSetInOrder(i.getMeasures().map(function(e){return e.name}),a.selectedMeasures,r)}return new e(a)};e.prototype.changeSingleMeasure=function(t){if(t.name===this.singleMeasure)return this;var i=this.valueOf();i.singleMeasure=t.name;i.splits=i.splits.changeSortIfOnMeasure(this.singleMeasure,t.name);i.pinnedSort=t.name;return new e(i)};e.prototype.toggleSelectedMeasure=function(t){var i=this.dataCube;var s=this.valueOf();var n=s.selectedMeasures;var r=t.name;if(n.indexOf(r)!==-1){s.selectedMeasures=immutable_class_1.SimpleArray.delete(n,r)}else{s.selectedMeasures=addToSetInOrder(i.getMeasures().map(function(e){return e.name}),n,r)}return new e(s)};e.prototype.toggleEffectiveMeasure=function(e){if(this.getMeasureMode()==="multi"){return this.toggleSelectedMeasure(e)}else{return this.changeSingleMeasure(e)}};e.prototype.acceptHighlight=function(){var e=this.highlight;if(!e)return this;return this.addToFilter(e.delta,true)};e.prototype.changeHighlight=function(t){var i=this.highlight;var s;if(i&&i.owner!==t.owner){s=this.addToFilter(i.delta).valueOf()}else{s=this.valueOf()}s.highlight=t;return new e(s)};e.prototype.dropHighlight=function(){var t=this.valueOf();t.highlight=null;return new e(t)};e.prototype.canInvertHighlight=function(){var e=this.highlight;if(!e)return false;if(this.getDimension(e.delta.clauses[0].dimension).isContinuous())return false;return true};e.prototype.invertHighlight=function(){var e=this.highlight;return this.changeHighlight(e.invert())};e.prototype.getCustomDimensions=function(){return this.customDimensions};e.prototype.changeCustomDimensions=function(t){var i=this.valueOf();i.customDimensions=t||[];return new e(i)};return e}();Essence.DEFAULT_DEFAULT_MEASURE_MODE={totals:"multi"};exports.Essence=Essence;check=Essence;