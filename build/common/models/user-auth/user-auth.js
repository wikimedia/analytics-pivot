"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var Promise=require("any-promise");var immutable_class_1=require("immutable-class");var user_1=require("../user/user");var sha2=beltful_1.HashUtils.sha2,bcryptHashSync=beltful_1.HashUtils.bcryptHashSync,saltedSha2=beltful_1.HashUtils.saltedSha2,bcryptCompare=beltful_1.HashUtils.bcryptCompare,bcryptHash=beltful_1.HashUtils.bcryptHash;var DEFAULT_ADMIN_PROPERTIES={name:user_1.User.DEFAULT_ADMIN_NAME,hashStrategy:"none"};var UserAuth=function(e){tslib_1.__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.getValidUser=function(e,t,r,s){var a=immutable_class_1.NamedArray.findByName(e,t);if(a)return a.passEquals(r,s).then(function(e){return e?a:null});return Promise.resolve(null)};t.getDefaultAdmin=function(e){var r=Object.assign({},DEFAULT_ADMIN_PROPERTIES,{pass:e,hashStrategy:"none"});return new t(r)};t.fromJS=function(e){return new t(immutable_class_1.BaseImmutable.jsToValue(t.PROPERTIES,e))};t.prototype.getHashStrategy=function(){var e=this.hashStrategy;return e||t.DEFAULT_HASH_STRATEGY};t.prototype.passEquals=function(e,t){if(!e)return Promise.resolve(false);var r=this.getHashStrategy();var s=this.pass;switch(r){case"none":return Promise.resolve(this.pass===e);case"sha2":return Promise.resolve(t?sha2(t+e)===s:saltedSha2(e)===s);case"bcrypt":return bcryptCompare(e,s);default:throw new Error("unrecognized strategy "+r)}};t.prototype.updatePass=function(e){var t=this;if(this.name===DEFAULT_ADMIN_PROPERTIES.name){throw new Error("Cannot change password for default admin")}var r=this.getHashStrategy();if(r==="sha2"){return Promise.resolve(this.changePass(saltedSha2(e)))}else if(r==="bcrypt"){return bcryptHash(e).then(function(e){return t.changePass(e)})}else{return Promise.resolve(this.changePass(e))}};t.prototype.toJS=function(){var t=this,r=t.name,s=t.hashStrategy;if(r===DEFAULT_ADMIN_PROPERTIES.name&&s===DEFAULT_ADMIN_PROPERTIES.hashStrategy){return DEFAULT_ADMIN_PROPERTIES}return e.prototype.toJS.call(this)};t.prototype.toClientUser=function(){return user_1.User.fromName(this.name)};return t}(immutable_class_1.BaseImmutable);UserAuth.DEFAULT_HASH_STRATEGY="bcrypt";UserAuth.PROPERTIES=[{name:"name"},{name:"pass",defaultValue:null},{name:"hashStrategy",defaultValue:UserAuth.DEFAULT_HASH_STRATEGY}];exports.UserAuth=UserAuth;immutable_class_1.BaseImmutable.finalize(UserAuth);